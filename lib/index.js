!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).AngryPixelMath={})}(this,(function(t){"use strict";var i,e,r;t.GeometricShape=void 0,(i=t.GeometricShape||(t.GeometricShape={}))[i.Polygon=0]="Polygon",i[i.Circumference=1]="Circumference",i[i.Line=2]="Line",t.RenderLocation=void 0,(e=t.RenderLocation||(t.RenderLocation={}))[e.WorldSpace=0]="WorldSpace",e[e.ViewPort=1]="ViewPort",t.RenderDataType=void 0,(r=t.RenderDataType||(t.RenderDataType={}))[r.Sprite=0]="Sprite",r[r.Text=1]="Text",r[r.Tilemap=2]="Tilemap",r[r.Mask=3]="Mask",r[r.Geometric=4]="Geometric";class o{constructor(t){this.gl=t,this.viewport={x:0,x1:0,y:0,y1:0},this.object={x:0,x1:0,y:0,y1:0}}setViewport({position:i,zoom:e},r){r===t.RenderLocation.WorldSpace?(this.viewport.x=i.x-this.gl.canvas.width/e/2,this.viewport.x1=i.x+this.gl.canvas.width/e/2,this.viewport.y=i.y-this.gl.canvas.height/e/2,this.viewport.y1=i.y+this.gl.canvas.height/e/2):(this.viewport.x=-this.gl.canvas.width/2,this.viewport.x1=this.gl.canvas.width/2,this.viewport.y=-this.gl.canvas.height/2,this.viewport.y1=this.gl.canvas.height/2)}setObjectForResizeable({position:t,width:i,height:e,rotation:r=0}){const o=Math.sin(r)*e+Math.cos(r)*i,s=Math.sin(r)*i+Math.cos(r)*e;this.object.x=t.x-o/2,this.object.x1=t.x+o/2,this.object.y=t.y-s/2,this.object.y1=t.y+s/2}setObjectForText({position:t,text:i,fontSize:e,lineSeparation:r,letterSpacing:o,rotation:s}){const a=i.split("\n").reduce(((t,i)=>Math.max(t,i.length)),0)*(e+(null!=o?o:0))*2,n=i.split("\n").length*(e+(null!=r?r:0));this.setObjectForResizeable({position:t,width:a,height:n,rotation:s})}setObjectForGeometric({position:i,vertexModel:e,shape:r,radius:o}){r===t.GeometricShape.Circumference?(this.object.x=i.x-o,this.object.y=i.y-o,this.object.x1=i.x+o,this.object.y1=i.y+o):(this.object.x=Number.MAX_SAFE_INTEGER,this.object.y=Number.MAX_SAFE_INTEGER,this.object.x1=Number.MIN_SAFE_INTEGER,this.object.y1=Number.MIN_SAFE_INTEGER,e.forEach((t=>{this.object.x=Math.min(t.x+i.x,this.object.x),this.object.y=Math.min(t.y+i.y,this.object.y),this.object.x1=Math.max(t.x+i.x,this.object.x1),this.object.y1=Math.max(t.y+i.y,this.object.y1)})))}setObjectForTilemap(t){t.tilemap.height=Math.ceil(t.tiles.length/t.tilemap.width),this.setObjectForResizeable({position:t.renderPosition,width:t.tilemap.width*t.tilemap.tileWidth,height:t.tilemap.height*t.tilemap.tileHeight,rotation:t.rotation})}applyCullingInTiles(t){const{tiles:i,tilemap:{width:e,tileWidth:r,tileHeight:o}}=t;t.culledTiles=i.map(((t,i)=>this.viewport.x1>=this.object.x+i%e*r&&this.viewport.x<=this.object.x+i%e*r+r&&this.viewport.y1>=this.object.y1-((i/e|0)*o+o)&&this.viewport.y<=this.object.y1-(i/e|0)*o?t:0))}isInViewPort(i,e){switch(this.setViewport(e,i.location),i.type){case t.RenderDataType.Mask:case t.RenderDataType.Sprite:this.setObjectForResizeable(i);break;case t.RenderDataType.Geometric:this.setObjectForGeometric(i);break;case t.RenderDataType.Text:this.setObjectForText(i);break;case t.RenderDataType.Tilemap:this.setObjectForTilemap(i)}return this.viewport.x1>=this.object.x&&this.viewport.x<=this.object.x1&&this.viewport.y1>=this.object.y&&this.viewport.y<=this.object.y1}applyCulling(i,e){return e.filter((e=>!!this.isInViewPort(e,i)&&(e.type===t.RenderDataType.Tilemap&&this.applyCullingInTiles(e),!0)))}}class s{constructor(t=0,i=0){this._x=t,this._y=i}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}get magnitude(){return Math.sqrt(Math.pow(this._x,2)+Math.pow(this._y,2))}set(t,i){this._x=t,this._y=i}copy(t){this.set(t.x,t.y)}equals(t){return this._x===t.x&&this._y===t.y}clone(){return new s(this._x,this._y)}distance(t){return Math.sqrt(Math.pow(this._x-t.x,2)+Math.pow(this._y-t.y,2))}static add(t,i,e){return t.set(i.x+e.x,i.y+e.y),t}static subtract(t,i,e){return t.set(i.x-e.x,i.y-e.y),t}static unit(t,i){return 0===i.magnitude?t.set(0,0):t.set(i.x/i.magnitude,i.y/i.magnitude),t}static normal(t,i){return t.set(-i.y,i.x),this.unit(t,t)}static scale(t,i,e){return t.set(i.x*e,i.y*e),t}static dot(t,i){return t.x*i.x+t.y*i.y}static cross(t,i){return t.x*i.y-t.y*i.x}static round(t,i){return t.set(Math.round(i.x),Math.round(i.y)),t}}var a;t.TilemapOrientation=void 0,(a=t.TilemapOrientation||(t.TilemapOrientation={}))[a.Center=0]="Center",a[a.RightUp=1]="RightUp",a[a.RightDown=2]="RightDown",a[a.RightCenter=3]="RightCenter";const n=i=>{i.renderPosition.set(i.position.x+(i.orientation!==t.TilemapOrientation.Center?i.tilemap.realWidth/2:0),i.position.y+(i.orientation===t.TilemapOrientation.RightDown?-i.tilemap.realHeight/2:i.orientation===t.TilemapOrientation.RightUp?i.tilemap.realHeight/2:0))};class h{constructor(t,i){this.webglManager=t,this.cullingManager=i,this.renderData=[],this.cameraData=[]}addRenderData(t){this.renderData.push(t)}addCameraData(t){this.cameraData.push(t)}render(){this.cameraData.sort(((t,i)=>t.depth-i.depth)).forEach((t=>this.renderByCamera(t)))}renderByCamera(i){this.cullingManager.applyCulling(i,this.renderData.filter((t=>i.layers.includes(t.layer))).sort(((t,e)=>i.layers.indexOf(t.layer)-i.layers.indexOf(e.layer))).map((i=>i.type===t.RenderDataType.Tilemap?(t=>{const i=Object.assign(Object.assign({},t),{culledTiles:[],tilemap:Object.assign(Object.assign({},t.tilemap),{height:Math.ceil(t.tiles.length/t.tilemap.width),realWidth:t.tilemap.width*t.tilemap.tileWidth,realHeight:0}),renderPosition:new s});return i.tilemap.realHeight=i.tilemap.height*i.tilemap.tileHeight,n(i),i})(i):i))).forEach((t=>this.webglManager.render(t,i)))}clearData(){this.renderData=[],this.cameraData=[]}clearScreen(t){this.webglManager.clearCanvas(t)}}var l;!function(t){t.LegacyWebGL="webgl",t.WebGL2="webgl2"}(l||(l={}));class g{constructor(t){if(this.canvas=t,this.contextVersion=this.getContextVersion(),!this.contextVersion)throw new Error("Your browser does not support WebGL.");this.gl=this.canvas.getContext(this.contextVersion)}getContextVersion(){return null!==this.canvas.getContext(l.WebGL2)?l.WebGL2:null!==this.canvas.getContext(l.LegacyWebGL)?l.LegacyWebGL:void 0}}class m{constructor(){this.fontAtlas=new Map}hasFontAtlas(t){return this.fontAtlas.has(Symbol.for(t instanceof FontFace?t.family:t))}getFontAtlas(t){return this.fontAtlas.get(Symbol.for(t instanceof FontFace?t.family:t))}getOrCreate(t,i,e){var r;return null!==(r=this.getFontAtlas(i))&&void 0!==r?r:this.create(t,i,e)}create(t,i,e){this.bitmapSize=e,this.chars=[];for(let i=0;i<t.length;i+=2)for(let e=t[i];e<=t[i+1];e++)this.chars.push(String.fromCharCode(e));const r=this.renderAtlas(i instanceof FontFace?i.family:i);return this.fontAtlas.set(Symbol.for(i instanceof FontFace?i.family:i),r),r}renderAtlas(t){const i=new c(t,this.bitmapSize,Math.ceil(Math.sqrt(this.chars.length))),e=i.canvas.getContext("2d");e.clearRect(0,0,i.canvas.width,i.canvas.height),e.textBaseline="top",e.fillStyle="#000",e.font=`${this.bitmapSize}px ${t}`;let r=0,o=0;for(let t=0;t<this.chars.length;t++)e.fillText(this.chars[t],r,o),i.glyphs.set(this.chars[t],{id:t,width:e.measureText(this.chars[t]).width}),(r+=this.bitmapSize)>i.canvas.width-this.bitmapSize&&(r=0,o+=this.bitmapSize);return i}}class c{constructor(t,i,e){this.fontFaceFamily=t,this.bitmapFontSize=i,this.gridSize=e,this.canvas=document.createElement("canvas"),this.glyphs=new Map,this.canvas.width=this.gridSize*this.bitmapFontSize,this.canvas.height=this.canvas.width}}class u{constructor(t,i){this.gl=t,this.shaderLoader=i}create(t,i){const e=this.gl.createProgram(),r=this.shaderLoader.load(this.gl.VERTEX_SHADER,t),o=this.shaderLoader.load(this.gl.FRAGMENT_SHADER,i);this.gl.attachShader(e,r),this.gl.attachShader(e,o),this.gl.linkProgram(e);const s=this.gl.LINK_STATUS;if(!this.gl.getProgramParameter(e,s)){const t=this.gl.getProgramInfoLog(e);throw this.gl.deleteProgram(e),new Error(`Unable to initialize the Program: ${t}`)}return e}}class x{constructor(t,i,e){this.gl=t,this.contextVersion=i,this.programFactory=e}loadProgram(){this.program=this.contextVersion===l.WebGL2?this.programFactory.create("#version 300 es\nprecision mediump float;\n\nin vec2 positionCoords;\nin vec2 textureCoords;\n\nout vec2 texCoords;\n\nuniform mat4 projectionMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 textureMatrix;\n\nvoid main()\n{\n    gl_Position = projectionMatrix * modelMatrix * vec4(positionCoords, 0, 1);\n    texCoords = (textureMatrix * vec4(textureCoords, 0, 1)).xy;\n}","#version 300 es\nprecision mediump float;\n\nout vec4 fragColor;\n\nin vec2 texCoords;\n\nuniform int u_renderTexture;\nuniform sampler2D u_texImage;\nuniform vec4 u_solidColor;\n\nuniform int u_useTintColor;\nuniform vec4 u_tintColor;\n\nuniform int u_useMaskColor;\nuniform vec4 u_maskColor;\nuniform float u_maskColorMix;\n\nuniform float u_alpha;\n\nvoid main()\n{\n    if (u_renderTexture == 1) {\n        vec4 texColor = texture(u_texImage, texCoords);\n\n        if (texColor.a < 0.0001) {\n            discard;\n        }\n\n        if (u_useTintColor == 1) {\n            texColor = u_tintColor * texColor;\n        }\n\n        if (u_useMaskColor == 1) {\n            texColor = mix(texColor, u_maskColor, clamp(u_maskColorMix, 0.0, 1.0));\n        }\n\n        fragColor = vec4(texColor.rgb, u_alpha * texColor.a);        \n    } else {\n        fragColor = vec4(u_solidColor.rgb, u_alpha);\n    }\n}"):this.programFactory.create("precision mediump float;\n\nattribute vec2 positionCoords;\nattribute vec2 textureCoords;\n\nvarying vec2 texCoords;\n\nuniform mat4 projectionMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 textureMatrix;\n\nvoid main()\n{\n    gl_Position = projectionMatrix * modelMatrix * vec4(positionCoords, 0, 1);\n    texCoords = (textureMatrix * vec4(textureCoords, 0, 1)).xy;\n}","precision mediump float;\n\nvarying vec2 texCoords;\n\nuniform int u_renderTexture;\nuniform sampler2D u_texImage;\nuniform vec4 u_solidColor;\n\nuniform int u_useTintColor;\nuniform vec4 u_tintColor;\n\nuniform int u_useMaskColor;\nuniform vec4 u_maskColor;\nuniform float u_maskColorMix;\n\nuniform float u_alpha;\n\nvoid main()\n{\n    if (u_renderTexture == 1) {\n        vec4 texColor = texture2D(u_texImage, texCoords);\n\n        if (texColor.a < 0.0001) {\n            discard;\n        }\n\n        if (u_useTintColor == 1) {\n            texColor = u_tintColor * texColor;\n        }\n\n        if (u_useMaskColor == 1) {\n            texColor = mix(texColor, u_maskColor, clamp(u_maskColorMix, 0.0, 1.0));\n        }\n\n        gl_FragColor = vec4(texColor.rgb, u_alpha * texColor.a);\n    } else {\n        gl_FragColor =  vec4(u_solidColor.rgb, u_alpha);\n    }\n}"),this.positionBuffer=this.gl.createBuffer(),this.textureBuffer=this.gl.createBuffer(),this.positionCoordsAttr=this.gl.getAttribLocation(this.program,"positionCoords"),this.texCoordsAttr=this.gl.getAttribLocation(this.program,"textureCoords"),this.modelMatrixUniform=this.gl.getUniformLocation(this.program,"modelMatrix"),this.projectionMatrixUniform=this.gl.getUniformLocation(this.program,"projectionMatrix"),this.textureMatrixUniform=this.gl.getUniformLocation(this.program,"textureMatrix"),this.renderTextureUniform=this.gl.getUniformLocation(this.program,"u_renderTexture"),this.textureUniform=this.gl.getUniformLocation(this.program,"u_texImage"),this.solidColorUniform=this.gl.getUniformLocation(this.program,"u_solidColor"),this.useTintColorUniform=this.gl.getUniformLocation(this.program,"u_useTintColor"),this.tintColorUniform=this.gl.getUniformLocation(this.program,"u_tintColor"),this.useMaskColorUniform=this.gl.getUniformLocation(this.program,"u_useMaskColor"),this.maskColorUniform=this.gl.getUniformLocation(this.program,"u_maskColor"),this.maskColorMixUniform=this.gl.getUniformLocation(this.program,"u_maskColorMix"),this.alphaUniform=this.gl.getUniformLocation(this.program,"u_alpha"),this.gl.useProgram(this.program),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enableVertexAttribArray(this.positionCoordsAttr),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.vertexAttribPointer(this.positionCoordsAttr,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.texCoordsAttr),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureBuffer),this.gl.vertexAttribPointer(this.texCoordsAttr,2,this.gl.FLOAT,!1,0,0)}}class d{constructor(t){this.gl=t}load(t,i){const e=this.gl.createShader(t);this.gl.shaderSource(e,i),this.gl.compileShader(e);const r=this.gl.COMPILE_STATUS;if(!this.gl.getShaderParameter(e,r)){const t=this.gl.getShaderInfoLog(e);throw this.gl.deleteShader(e),new Error(`Unable to initialize the shader program: ${t}`)}return e}}var p="undefined"!=typeof Float32Array?Float32Array:Array;function f(){var t=new p(16);return p!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function M(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function y(t,i,e){var r,o,s,a,n,h,l,g,m,c,u,x,d=e[0],p=e[1],f=e[2];return i===t?(t[12]=i[0]*d+i[4]*p+i[8]*f+i[12],t[13]=i[1]*d+i[5]*p+i[9]*f+i[13],t[14]=i[2]*d+i[6]*p+i[10]*f+i[14],t[15]=i[3]*d+i[7]*p+i[11]*f+i[15]):(r=i[0],o=i[1],s=i[2],a=i[3],n=i[4],h=i[5],l=i[6],g=i[7],m=i[8],c=i[9],u=i[10],x=i[11],t[0]=r,t[1]=o,t[2]=s,t[3]=a,t[4]=n,t[5]=h,t[6]=l,t[7]=g,t[8]=m,t[9]=c,t[10]=u,t[11]=x,t[12]=r*d+n*p+m*f+i[12],t[13]=o*d+h*p+c*f+i[13],t[14]=s*d+l*p+u*f+i[14],t[15]=a*d+g*p+x*f+i[15]),t}function v(t,i,e){var r=e[0],o=e[1],s=e[2];return t[0]=i[0]*r,t[1]=i[1]*r,t[2]=i[2]*r,t[3]=i[3]*r,t[4]=i[4]*o,t[5]=i[5]*o,t[6]=i[6]*o,t[7]=i[7]*o,t[8]=i[8]*s,t[9]=i[9]*s,t[10]=i[10]*s,t[11]=i[11]*s,t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],t}function R(t,i,e){var r=Math.sin(e),o=Math.cos(e),s=i[0],a=i[1],n=i[2],h=i[3],l=i[4],g=i[5],m=i[6],c=i[7];return i!==t&&(t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15]),t[0]=s*o+l*r,t[1]=a*o+g*r,t[2]=n*o+m*r,t[3]=h*o+c*r,t[4]=l*o-s*r,t[5]=g*o-a*r,t[6]=m*o-n*r,t[7]=c*o-h*r,t}Math.hypot||(Math.hypot=function(){for(var t=0,i=arguments.length;i--;)t+=arguments[i]*arguments[i];return Math.sqrt(t)});var C=function(t,i,e,r,o,s,a){var n=1/(i-e),h=1/(r-o),l=1/(s-a);return t[0]=-2*n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(i+e)*n,t[13]=(o+r)*h,t[14]=(a+s)*l,t[15]=1,t};function T(){var t=new p(3);return p!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function b(t,i,e){var r=new p(3);return r[0]=t,r[1]=i,r[2]=e,r}function A(){var t=new p(4);return p!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}T(),function(){var t,i=(t=new p(4),p!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var _;T(),b(1,0,0),b(0,1,0),A(),A(),_=new p(9),p!=Float32Array&&(_[1]=0,_[2]=0,_[3]=0,_[5]=0,_[6]=0,_[7]=0),_[0]=1,_[4]=1,_[8]=1,function(){var t=function(){var t=new p(2);return p!=Float32Array&&(t[0]=0,t[1]=0),t}()}();const w=t=>{const i=/^#?([a-f\d]{2})?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[2],16)/256,g:parseInt(i[3],16)/256,b:parseInt(i[4],16)/256,a:void 0!==i[1]?parseInt(i[1],16)/256:1}:null},F=(i,e,r,o)=>{var s,a;i=M(i),C(i,-e.canvas.width/2,e.canvas.width/2,-e.canvas.height/2,e.canvas.height/2,-1,1),y(i,i,[0,0,0]),o===t.RenderLocation.WorldSpace&&v(i,i,[null!==(s=r.zoom)&&void 0!==s?s:1,null!==(a=r.zoom)&&void 0!==a?a:1,1])};class U{constructor(t,i){this.gl=t,this.programManager=i,this.vertices=new Map,this.lastVertices=null,this.modelPosition=new s,this.projectionMatrix=f(),this.modelMatrix=f(),this.textureMatrix=f();const e=2*Math.PI/60;this.circumferenceVertices=new Float32Array(((t,i,e=1)=>{const r=[];for(let o=t;o<=i;o+=e)r.push(o);return r})(1,60,1).reduce(((t,i)=>[...t,Math.cos(i*e),Math.sin(i*e)]),[]))}render(i,e,r){switch(i.shape){case t.GeometricShape.Polygon:this.renderLines(i,e,this.gl.LINE_LOOP,r);break;case t.GeometricShape.Line:this.renderLines(i,e,this.gl.LINES,r);break;case t.GeometricShape.Circumference:this.renderCircumference(i,e)}}renderLines(i,e,r,o){var a;const n=this.generateVerticesKey(i.vertexModel);!1===this.vertices.has(n)&&this.vertices.set(n,new Float32Array(this.generatePolygonVertices(i.vertexModel)));const h=this.vertices.get(n);this.lastVertices===n&&o===t.RenderDataType.Geometric||(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,h,this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,h,this.gl.DYNAMIC_DRAW)),this.lastVertices=n,this.modelMatrix=M(this.modelMatrix),s.round(this.modelPosition,i.location===t.RenderLocation.WorldSpace?s.subtract(this.modelPosition,i.position,e.position):i.position),y(this.modelMatrix,this.modelMatrix,[this.modelPosition.x,this.modelPosition.y,0]),R(this.modelMatrix,this.modelMatrix,null!==(a=i.rotation)&&void 0!==a?a:0),F(this.projectionMatrix,this.gl,e,i.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.uniform1i(this.programManager.renderTextureUniform,0);const{r:l,g:g,b:m,a:c}=w(i.color);this.gl.uniform4f(this.programManager.solidColorUniform,l,g,m,c),this.gl.uniform1f(this.programManager.alphaUniform,1),this.gl.drawArrays(r,0,h.length/2)}generateVerticesKey(t){return Symbol.for(t.reduce(((t,i)=>`${t}${i.x}${i.y}`),t.length.toString()))}generatePolygonVertices(t){const i=[];for(let e=0;e<t.length;e++)i.push(t[e].x,t[e].y);return i}renderCircumference(t,i){this.lastVertices=null,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.circumferenceVertices,this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.circumferenceVertices,this.gl.DYNAMIC_DRAW),this.modelMatrix=M(this.modelMatrix),y(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),v(this.modelMatrix,this.modelMatrix,[t.radius,t.radius,1]),F(this.projectionMatrix,this.gl,i,t.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.uniform1i(this.programManager.renderTextureUniform,0);const{r:e,g:r,b:o,a:s}=w(t.color);this.gl.uniform4f(this.programManager.solidColorUniform,e,r,o,s),this.gl.uniform1f(this.programManager.alphaUniform,1),this.gl.drawArrays(this.gl.LINE_LOOP,0,this.circumferenceVertices.length/2)}}class E{constructor(i,e){this.gl=i,this.programManager=e,this.type=t.RenderDataType.Mask,this.vertices=new Float32Array([-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5]),this.modelPosition=new s,this.projectionMatrix=f(),this.modelMatrix=f(),this.textureMatrix=f()}render(i,e,r){var o,a;r!==t.RenderDataType.Mask&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.vertices,this.gl.STATIC_DRAW)),this.modelMatrix=M(this.modelMatrix),s.round(this.modelPosition,i.location===t.RenderLocation.WorldSpace?s.subtract(this.modelPosition,i.position,e.position):i.position),y(this.modelMatrix,this.modelMatrix,[this.modelPosition.x,this.modelPosition.y,0]),R(this.modelMatrix,this.modelMatrix,null!==(o=i.rotation)&&void 0!==o?o:0),v(this.modelMatrix,this.modelMatrix,[i.width,i.height,1]),F(this.projectionMatrix,this.gl,e,i.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),i.alpha&&i.alpha<1?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this.gl.uniform1i(this.programManager.renderTextureUniform,0);const{r:n,g:h,b:l,a:g}=w(i.color);this.gl.uniform4f(this.programManager.solidColorUniform,n,h,l,g),this.gl.uniform1f(this.programManager.alphaUniform,null!==(a=i.alpha)&&void 0!==a?a:1),this.gl.drawArrays(this.gl.TRIANGLES,0,6)}}class S{constructor(t,i,e){this.gl=t,this.programManager=i,this.textureManager=e,this.lastTexture=null,this.modelPosition=new s,this.projectionMatrix=f(),this.modelMatrix=f(),this.textureMatrix=f(),this.posVertices=new Float32Array([-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5]),this.texVertices=new Float32Array([0,1,0,0,1,1,1,1,0,0,1,0])}render(i,e,r){var o,a,n,h;r!==i.type&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.posVertices,this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.texVertices,this.gl.STATIC_DRAW)),this.modelMatrix=M(this.modelMatrix),s.round(this.modelPosition,i.location===t.RenderLocation.WorldSpace?s.subtract(this.modelPosition,i.position,e.position):i.position),y(this.modelMatrix,this.modelMatrix,[this.modelPosition.x,this.modelPosition.y,0]),R(this.modelMatrix,this.modelMatrix,null!==(o=i.rotation)&&void 0!==o?o:0),v(this.modelMatrix,this.modelMatrix,[i.width*(i.flipHorizontal?-1:1),i.height*(i.flipVertical?-1:1),1]),this.textureMatrix=M(this.textureMatrix),i.slice&&(y(this.textureMatrix,this.textureMatrix,[i.slice.x/i.image.naturalWidth,i.slice.y/i.image.naturalHeight,0]),v(this.textureMatrix,this.textureMatrix,[i.slice.width/i.image.naturalWidth,i.slice.height/i.image.naturalHeight,1])),F(this.projectionMatrix,this.gl,e,i.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.enable(this.gl.BLEND);const l=this.textureManager.getOrCreateTextureFromImage(i.image,i.smooth);if(this.lastTexture===l&&r===i.type||(this.gl.bindTexture(this.gl.TEXTURE_2D,l),this.gl.uniform1i(this.programManager.textureUniform,0),this.lastTexture=l),this.gl.uniform1i(this.programManager.renderTextureUniform,1),this.gl.uniform1f(this.programManager.alphaUniform,null!==(a=i.alpha)&&void 0!==a?a:1),this.gl.uniform1i(this.programManager.useTintColorUniform,i.tintColor?1:0),i.tintColor){const{r:t,g:e,b:r,a:o}=w(i.tintColor);this.gl.uniform4f(this.programManager.tintColorUniform,t,e,r,o)}if(this.gl.uniform1i(this.programManager.useMaskColorUniform,i.maskColor?1:0),i.maskColor){const{r:t,g:e,b:r}=w(i.maskColor);this.gl.uniform4f(this.programManager.maskColorUniform,t,e,r,null!==(n=i.alpha)&&void 0!==n?n:1),this.gl.uniform1f(this.programManager.maskColorMixUniform,null!==(h=i.maskColorMix)&&void 0!==h?h:1)}this.gl.drawArrays(this.gl.TRIANGLES,0,6)}}var D;t.TextOrientation=void 0,(D=t.TextOrientation||(t.TextOrientation={}))[D.Center=0]="Center",D[D.RightUp=1]="RightUp",D[D.RightDown=2]="RightDown",D[D.RightCenter=3]="RightCenter";const L=new s,P=new s,j=[32,126,161,255],B=t.TextOrientation.Center;class I{constructor(i,e,r,o){this.gl=i,this.programManager=e,this.textureManager=r,this.fontAtlasFactory=o,this.type=t.RenderDataType.Text,this.posVertices=[],this.texVertices=[],this.lastTexture=null,this.textSize=new s,this.modelPosition=new s,this.projectionMatrix=f(),this.modelMatrix=f(),this.textureMatrix=f()}render(i,e,r){var o;if(!i.text)return;this.setDefaultValues(i);const a=this.fontAtlasFactory.getOrCreate(i.bitmap.charRanges,i.font,i.bitmap.fontSize);this.generateTextVertices(a,i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.posVertices),this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.texVertices),this.gl.DYNAMIC_DRAW),this.modelMatrix=M(this.modelMatrix),this.setPositionFromOrientation(i),s.round(this.modelPosition,i.location===t.RenderLocation.WorldSpace?s.subtract(this.modelPosition,this.modelPosition,e.position):this.modelPosition),y(this.modelMatrix,this.modelMatrix,[this.modelPosition.x,this.modelPosition.y,0]),R(this.modelMatrix,this.modelMatrix,null!==(o=i.rotation)&&void 0!==o?o:0),v(this.modelMatrix,this.modelMatrix,[i.fontSize,i.fontSize,1]),this.textureMatrix=M(this.textureMatrix),F(this.projectionMatrix,this.gl,e,i.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),i.opacity<1?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND);const n=this.textureManager.getOrCreateTextureFromCanvas(a.fontFaceFamily,a.canvas,i.smooth);this.lastTexture===n&&r===t.RenderDataType.Text||(this.gl.bindTexture(this.gl.TEXTURE_2D,n),this.gl.uniform1i(this.programManager.textureUniform,0),this.lastTexture=n),this.gl.uniform1i(this.programManager.useTintColorUniform,0),this.gl.uniform1i(this.programManager.renderTextureUniform,1),this.gl.uniform1f(this.programManager.alphaUniform,i.opacity);const{r:h,g:l,b:g,a:m}=w(i.color);this.gl.uniform4f(this.programManager.maskColorUniform,h,l,g,m),this.gl.uniform1f(this.programManager.maskColorMixUniform,1),this.gl.uniform1i(this.programManager.useMaskColorUniform,1),this.gl.drawArrays(this.gl.TRIANGLES,0,this.posVertices.length/2)}setDefaultValues(t){var i,e,r,o,s,a,n,h,l,g;t.bitmap?(t.bitmap.margin=null!==(i=t.bitmap.margin)&&void 0!==i?i:L,t.bitmap.spacing=null!==(e=t.bitmap.spacing)&&void 0!==e?e:P,t.bitmap.fontSize=null!==(r=t.bitmap.fontSize)&&void 0!==r?r:64,t.bitmap.charRanges=null!==(o=t.bitmap.charRanges)&&void 0!==o?o:j):t.bitmap={margin:L,spacing:P,fontSize:64,charRanges:j},t.color=null!==(s=t.color)&&void 0!==s?s:"#000000",t.letterSpacing=null!==(a=t.letterSpacing)&&void 0!==a?a:0,t.lineSeparation=null!==(n=t.lineSeparation)&&void 0!==n?n:0,t.opacity=null!==(h=t.opacity)&&void 0!==h?h:1,t.orientation=null!==(l=t.orientation)&&void 0!==l?l:B,t.rotation=null!==(g=t.rotation)&&void 0!==g?g:0}generateTextVertices(t,{text:i,fontSize:e,bitmap:r,letterSpacing:o,lineSeparation:s}){this.posVertices=[],this.texVertices=[];let a=0,n=0,h=0;o/=e,s/=e;for(let e=0;e<i.length;e++){const l=i[e];if("\n"===l){h=Math.max(h,a),a=0,n-=1+s;continue}const g=t.glyphs.get(l);if(g){const i=g.width/t.bitmapFontSize;this.posVertices.push(a,n-1,a+i,n-1,a,n,a,n,a+i,n-1,a+i,n);const e=g.id%t.gridSize*t.bitmapFontSize,s=(g.id/t.gridSize|0)*t.bitmapFontSize,h=(e+r.margin.x)/t.canvas.width,l=(s+r.margin.y)/t.canvas.width,m=(e+g.width+r.spacing.x)/t.canvas.width,c=(s+t.bitmapFontSize+r.spacing.y)/t.canvas.width;this.texVertices.push(h,c,m,c,h,l,h,l,m,c,m,l),a+=i+o}}this.textSize.set(Math.max(h,a)*e,Math.abs(n-1)*e)}setPositionFromOrientation(i){this.modelPosition.set(i.position.x+(i.orientation===t.TextOrientation.Center?-this.textSize.x/2:0),i.position.y+(i.orientation===t.TextOrientation.Center||i.orientation===t.TextOrientation.RightCenter?this.textSize.y/2:i.orientation===t.TextOrientation.RightUp?this.textSize.y:0))}}class V{constructor(t,i,e){this.gl=t,this.programManager=i,this.textureManager=e,this.posVertices=[],this.texVertices=[],this.lastTexture=null,this.tileset={width:0,tileWidth:0,tileHeight:0,texMargin:new s,texSpacing:new s,texWidth:0,texHeight:0,texCorrection:new s},this.modelPosition=new s,this.projectionMatrix=f(),this.modelMatrix=f(),this.textureMatrix=f()}render(i,e,r){var o,a,n,h;this.processTileset(i),this.generateVertices(i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.posVertices),this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.texVertices),this.gl.DYNAMIC_DRAW),this.modelMatrix=M(this.modelMatrix),s.round(this.modelPosition,i.location===t.RenderLocation.WorldSpace?s.subtract(this.modelPosition,i.renderPosition,e.position):i.renderPosition),y(this.modelMatrix,this.modelMatrix,[this.modelPosition.x,this.modelPosition.y,0]),R(this.modelMatrix,this.modelMatrix,null!==(o=i.rotation)&&void 0!==o?o:0),v(this.modelMatrix,this.modelMatrix,[i.tilemap.tileWidth*(i.flipHorizontal?-1:1),i.tilemap.tileHeight*(i.flipVertical?-1:1),1]),this.textureMatrix=M(this.textureMatrix),v(this.textureMatrix,this.textureMatrix,[this.tileset.tileWidth/i.tileset.image.naturalWidth,this.tileset.tileHeight/i.tileset.image.naturalHeight,1]),F(this.projectionMatrix,this.gl,e,i.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.enable(this.gl.BLEND);const l=this.textureManager.getOrCreateTextureFromImage(i.tileset.image,i.smooth);if(this.lastTexture===l&&r===t.RenderDataType.Tilemap||(this.gl.bindTexture(this.gl.TEXTURE_2D,l),this.gl.uniform1i(this.programManager.textureUniform,0),this.lastTexture=l),this.gl.uniform1i(this.programManager.renderTextureUniform,1),this.gl.uniform1f(this.programManager.alphaUniform,null!==(a=i.alpha)&&void 0!==a?a:1),this.gl.uniform1i(this.programManager.useTintColorUniform,i.tintColor?1:0),i.tintColor){const{r:t,g:e,b:r,a:o}=w(i.tintColor);this.gl.uniform4f(this.programManager.tintColorUniform,t,e,r,o)}if(this.gl.uniform1i(this.programManager.useMaskColorUniform,i.maskColor?1:0),i.maskColor){const{r:t,g:e,b:r}=w(i.maskColor);this.gl.uniform4f(this.programManager.maskColorUniform,t,e,r,null!==(n=i.alpha)&&void 0!==n?n:1),this.gl.uniform1f(this.programManager.maskColorMixUniform,null!==(h=i.maskColorMix)&&void 0!==h?h:1)}this.gl.drawArrays(this.gl.TRIANGLES,0,this.posVertices.length/2)}processTileset({tileset:t}){var i,e,r,o,a,n,h;t.margin=null!==(i=t.margin)&&void 0!==i?i:new s,t.spacing=null!==(e=t.spacing)&&void 0!==e?e:new s,t.correction=null!==(r=t.correction)&&void 0!==r?r:new s,this.tileset.width=t.width,this.tileset.tileWidth=t.tileWidth+(null!==(o=t.margin.x)&&void 0!==o?o:0)+(null!==(a=t.spacing.x)&&void 0!==a?a:0),this.tileset.tileHeight=t.tileHeight+(null!==(n=t.margin.y)&&void 0!==n?n:0)+(null!==(h=t.spacing.y)&&void 0!==h?h:0),this.tileset.texMargin.set(t.margin.x/this.tileset.tileWidth,t.margin.y/this.tileset.tileHeight),this.tileset.texSpacing.set(t.spacing.x/this.tileset.tileWidth,t.spacing.y/this.tileset.tileHeight),this.tileset.texCorrection.set(t.correction.x/this.tileset.tileWidth,t.correction.y/this.tileset.tileHeight),this.tileset.texWidth=1-this.tileset.texMargin.x-this.tileset.texSpacing.x-2*this.tileset.texCorrection.x,this.tileset.texHeight=1-this.tileset.texMargin.y-this.tileset.texSpacing.y-2*this.tileset.texCorrection.y}generateVertices({culledTiles:t,tilemap:i}){this.posVertices=[],this.texVertices=[];const e=Math.floor(t.length/i.width);t.forEach(((t,r)=>{if(0===t)return;const o=r%i.width-i.width/2,s=e/2-Math.floor(r/i.width);this.posVertices.push(o,s-1,o+1,s-1,o,s,o,s,o+1,s-1,o+1,s);const a=(t-1)%this.tileset.width+this.tileset.texMargin.x+this.tileset.texCorrection.x,n=Math.floor((t-1)/this.tileset.width)+this.tileset.texMargin.y+this.tileset.texCorrection.y;this.texVertices.push(a,n+this.tileset.texHeight,a+this.tileset.texWidth,n+this.tileset.texHeight,a,n,a,n,a+this.tileset.texWidth,n+this.tileset.texHeight,a+this.tileset.texWidth,n)}))}}class O{constructor(t){this.gl=t}createFromImage(t,i=!0,e=null){return e=null!=e?e:this.gl.createTexture(),t.naturalWidth?this.create(t,e,i):t.addEventListener("load",(()=>this.create(t,e,i))),e}createFromCanvas(t,i=!0,e=null){return e=null!=e?e:this.gl.createTexture(),this.create(t,e,i),e}create(t,i,e=!0){this.gl.bindTexture(this.gl.TEXTURE_2D,i),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),!1===e?(this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST)):(this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR)),this.gl.bindTexture(this.gl.TEXTURE_2D,null)}}class W{constructor(t){this.textureFactory=t,this.textures=new Map}getOrCreateTextureFromImage(t,i=!0){var e;return null!==(e=this.textures.get(Symbol.for(t.src)))&&void 0!==e?e:this.createTextureFromImage(t,i)}createTextureFromImage(t,i=!0){const e=this.textureFactory.createFromImage(t,i);return this.textures.set(Symbol.for(t.src),e),e}getOrCreateTextureFromCanvas(t,i,e=!0){var r;return null!==(r=this.textures.get(Symbol.for(t)))&&void 0!==r?r:this.createTextureFromCanvas(t,i,e)}createTextureFromCanvas(t,i,e=!0){const r=this.textureFactory.createFromCanvas(i,e);return this.textures.set(Symbol.for(t),r),r}}class k{constructor(t,i,e){this.gl=t,this.renderers=e,i.loadProgram()}render(t,i){this.renderers.get(t.type).render(t,i,this.lastRender),this.lastRender=t.type}clearCanvas(t){const i=w(t);this.gl.clearColor(i.r,i.g,i.b,i.a),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}}t.renderManagerFactory=i=>{const e=new g(i),r=e.gl,s=e.contextVersion,a=new x(r,s,new u(r,new d(r))),n=new W(new O(r)),l=new k(r,a,new Map([[t.RenderDataType.Sprite,new S(r,a,n)],[t.RenderDataType.Text,new I(r,a,n,new m)],[t.RenderDataType.Tilemap,new V(r,a,n)],[t.RenderDataType.Geometric,new U(r,a)],[t.RenderDataType.Mask,new E(r,a)]]));return new h(l,new o(r))},Object.defineProperty(t,"__esModule",{value:!0})}));
