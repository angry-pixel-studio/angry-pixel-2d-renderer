var t,r,i;!function(t){t[t.WorldSpace=0]="WorldSpace",t[t.ViewPort=1]="ViewPort"}(t||(t={})),function(t){t[t.Sprite=0]="Sprite",t[t.Text=1]="Text",t[t.Tilemap=2]="Tilemap",t[t.Mask=3]="Mask",t[t.Geometric=4]="Geometric"}(r||(r={}));class e{constructor(t){this.webglManager=t,this.renderData=[],this.cameraData=[]}addRenderData(t){this.renderData.push(t)}addCameraData(t){this.cameraData.push(t)}render(){this.cameraData.sort(((t,r)=>t.depth-r.depth)).forEach((t=>this.renderByCamera(t)))}renderByCamera(t){this.renderData.filter((r=>t.layers.includes(r.layer))).sort(((r,i)=>t.layers.indexOf(r.layer)-t.layers.indexOf(i.layer))).forEach((r=>{this.webglManager.render(r,t)}))}clearData(){this.renderData=[],this.cameraData=[]}clearScreen(t){this.webglManager.clearCanvas(t)}}!function(t){t.LegacyWebGL="webgl",t.WebGL2="webgl2"}(i||(i={}));class o{constructor(t){if(this.canvas=t,this.contextVersion=this.getContextVersion(),!this.contextVersion)throw new Error("Your browser does not support WebGL.");this.gl=this.canvas.getContext(this.contextVersion)}getContextVersion(){return null!==this.canvas.getContext(i.WebGL2)?i.WebGL2:null!==this.canvas.getContext(i.LegacyWebGL)?i.LegacyWebGL:void 0}}class a{constructor(){this.fontAtlas=new Map}hasFontAtlas(t){return this.fontAtlas.has(Symbol.for(t.family))}getFontAtlas(t){return this.fontAtlas.get(Symbol.for(t.family))}getOrCreate(t,r,i){var e;return null!==(e=this.getFontAtlas(r))&&void 0!==e?e:this.create(t,r,i)}create(t,r,i){this.bitmapSize=i,this.chars=[];for(let r=0;r<t.length;r+=2)for(let i=t[r];i<=t[r+1];i++)this.chars.push(String.fromCharCode(i));const e=this.renderAtlas(r);return this.fontAtlas.set(Symbol.for(r.family),e),e}renderAtlas(t){const r=new s(t);r.canvas.width=Math.round(Math.sqrt(this.chars.length))*this.bitmapSize,r.canvas.height=r.canvas.width;const i=r.canvas.getContext("2d");i.clearRect(0,0,r.canvas.width,r.canvas.height),i.textBaseline="top",i.fillStyle="#000",i.font=`${this.bitmapSize}px ${t.family}`;let e=0,o=0;for(let t=0;t<this.chars.length;t++)i.fillText(this.chars[t],e,o),r.glyphsData.set(this.chars[t],{x:e,y:o,width:this.bitmapSize,height:this.bitmapSize}),(e+=this.bitmapSize)>r.canvas.width-this.bitmapSize&&(e=0,o+=this.bitmapSize);return r}}class s{constructor(t){this.fontFace=t,this.canvas=document.createElement("canvas"),this.glyphsData=new Map}}class n{constructor(t,r){this.gl=t,this.shaderLoader=r}create(t,r){const i=this.gl.createProgram(),e=this.shaderLoader.load(this.gl.VERTEX_SHADER,t),o=this.shaderLoader.load(this.gl.FRAGMENT_SHADER,r);this.gl.attachShader(i,e),this.gl.attachShader(i,o),this.gl.linkProgram(i);const a=this.gl.LINK_STATUS;if(!this.gl.getProgramParameter(i,a)){const t=this.gl.getProgramInfoLog(i);throw this.gl.deleteProgram(i),new Error(`Unable to initialize the Program: ${t}`)}return i}}class h{constructor(t,r,i){this.gl=t,this.contextVersion=r,this.programFactory=i}loadProgram(){this.program=this.contextVersion===i.WebGL2?this.programFactory.create("#version 300 es\nprecision mediump float;\n\nin vec2 positionCoords;\nin vec2 textureCoords;\n\nout vec2 texCoords;\n\nuniform mat4 projectionMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 textureMatrix;\n\nvoid main()\n{\n    gl_Position = projectionMatrix * modelMatrix * vec4(positionCoords, 0, 1);\n    texCoords = (textureMatrix * vec4(textureCoords, 0, 1)).xy;\n}","#version 300 es\nprecision mediump float;\n\nout vec4 fragColor;\n\nin vec2 texCoords;\n\nuniform int u_renderTexture;\nuniform sampler2D u_texImage;\nuniform vec4 u_solidColor;\n\nuniform int u_useTintColor;\nuniform vec4 u_tintColor;\n\nuniform int u_useMaskColor;\nuniform vec4 u_maskColor;\nuniform float u_maskColorMix;\n\nuniform float u_alpha;\n\nvoid main()\n{\n    if (u_renderTexture == 1) {\n        vec4 texColor = texture(u_texImage, texCoords);\n\n        if (texColor.a < 0.0001) {\n            discard;\n        }\n\n        if (u_useTintColor == 1) {\n            texColor = u_tintColor * texColor;\n        }\n\n        if (u_useMaskColor == 1) {\n            texColor = mix(texColor, u_maskColor, clamp(u_maskColorMix, 0.0, 1.0));\n        }\n\n        fragColor = vec4(texColor.rgb, u_alpha * texColor.a);        \n    } else {\n        fragColor = vec4(u_solidColor.rgb, u_alpha);\n    }\n}"):this.programFactory.create("precision mediump float;\n\nattribute vec2 positionCoords;\nattribute vec2 textureCoords;\n\nvarying vec2 texCoords;\n\nuniform mat4 projectionMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 textureMatrix;\n\nvoid main()\n{\n    gl_Position = projectionMatrix * modelMatrix * vec4(positionCoords, 0, 1);\n    texCoords = (textureMatrix * vec4(textureCoords, 0, 1)).xy;\n}","precision mediump float;\n\nvarying vec2 texCoords;\n\nuniform int u_renderTexture;\nuniform sampler2D u_texImage;\nuniform vec4 u_solidColor;\n\nuniform int u_useTintColor;\nuniform vec4 u_tintColor;\n\nuniform int u_useMaskColor;\nuniform vec4 u_maskColor;\nuniform float u_maskColorMix;\n\nuniform float u_alpha;\n\nvoid main()\n{\n    if (u_renderTexture == 1) {\n        vec4 texColor = texture2D(u_texImage, texCoords);\n\n        if (texColor.a < 0.0001) {\n            discard;\n        }\n\n        if (u_useTintColor == 1) {\n            texColor = u_tintColor * texColor;\n        }\n\n        if (u_useMaskColor == 1) {\n            texColor = mix(texColor, u_maskColor, clamp(u_maskColorMix, 0.0, 1.0));\n        }\n\n        gl_FragColor = vec4(texColor.rgb, u_alpha * texColor.a);\n    } else {\n        gl_FragColor =  vec4(u_solidColor.rgb, u_alpha);\n    }\n}"),this.positionBuffer=this.gl.createBuffer(),this.textureBuffer=this.gl.createBuffer(),this.positionCoordsAttr=this.gl.getAttribLocation(this.program,"positionCoords"),this.texCoordsAttr=this.gl.getAttribLocation(this.program,"textureCoords"),this.modelMatrixUniform=this.gl.getUniformLocation(this.program,"modelMatrix"),this.projectionMatrixUniform=this.gl.getUniformLocation(this.program,"projectionMatrix"),this.textureMatrixUniform=this.gl.getUniformLocation(this.program,"textureMatrix"),this.renderTextureUniform=this.gl.getUniformLocation(this.program,"u_renderTexture"),this.textureUniform=this.gl.getUniformLocation(this.program,"u_texImage"),this.solidColorUniform=this.gl.getUniformLocation(this.program,"u_solidColor"),this.useTintColorUniform=this.gl.getUniformLocation(this.program,"u_useTintColor"),this.tintColorUniform=this.gl.getUniformLocation(this.program,"u_tintColor"),this.useMaskColorUniform=this.gl.getUniformLocation(this.program,"u_useMaskColor"),this.maskColorUniform=this.gl.getUniformLocation(this.program,"u_maskColor"),this.maskColorMixUniform=this.gl.getUniformLocation(this.program,"u_maskColorMix"),this.alphaUniform=this.gl.getUniformLocation(this.program,"u_alpha"),this.gl.useProgram(this.program),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enableVertexAttribArray(this.positionCoordsAttr),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.vertexAttribPointer(this.positionCoordsAttr,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.texCoordsAttr),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureBuffer),this.gl.vertexAttribPointer(this.texCoordsAttr,2,this.gl.FLOAT,!1,0,0)}}class l{constructor(t){this.gl=t}load(t,r){const i=this.gl.createShader(t);this.gl.shaderSource(i,r),this.gl.compileShader(i);const e=this.gl.COMPILE_STATUS;if(!this.gl.getShaderParameter(i,e)){const t=this.gl.getShaderInfoLog(i);throw this.gl.deleteShader(i),new Error(`Unable to initialize the shader program: ${t}`)}return i}}var g="undefined"!=typeof Float32Array?Float32Array:Array;function u(){var t=new g(16);return g!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function m(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function x(t,r,i){var e,o,a,s,n,h,l,g,u,m,x,c,f=i[0],d=i[1],p=i[2];return r===t?(t[12]=r[0]*f+r[4]*d+r[8]*p+r[12],t[13]=r[1]*f+r[5]*d+r[9]*p+r[13],t[14]=r[2]*f+r[6]*d+r[10]*p+r[14],t[15]=r[3]*f+r[7]*d+r[11]*p+r[15]):(e=r[0],o=r[1],a=r[2],s=r[3],n=r[4],h=r[5],l=r[6],g=r[7],u=r[8],m=r[9],x=r[10],c=r[11],t[0]=e,t[1]=o,t[2]=a,t[3]=s,t[4]=n,t[5]=h,t[6]=l,t[7]=g,t[8]=u,t[9]=m,t[10]=x,t[11]=c,t[12]=e*f+n*d+u*p+r[12],t[13]=o*f+h*d+m*p+r[13],t[14]=a*f+l*d+x*p+r[14],t[15]=s*f+g*d+c*p+r[15]),t}function c(t,r,i){var e=i[0],o=i[1],a=i[2];return t[0]=r[0]*e,t[1]=r[1]*e,t[2]=r[2]*e,t[3]=r[3]*e,t[4]=r[4]*o,t[5]=r[5]*o,t[6]=r[6]*o,t[7]=r[7]*o,t[8]=r[8]*a,t[9]=r[9]*a,t[10]=r[10]*a,t[11]=r[11]*a,t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15],t}function f(t,r,i){var e=Math.sin(i),o=Math.cos(i),a=r[0],s=r[1],n=r[2],h=r[3],l=r[4],g=r[5],u=r[6],m=r[7];return r!==t&&(t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15]),t[0]=a*o+l*e,t[1]=s*o+g*e,t[2]=n*o+u*e,t[3]=h*o+m*e,t[4]=l*o-a*e,t[5]=g*o-s*e,t[6]=u*o-n*e,t[7]=m*o-h*e,t}Math.hypot||(Math.hypot=function(){for(var t=0,r=arguments.length;r--;)t+=arguments[r]*arguments[r];return Math.sqrt(t)});var d=function(t,r,i,e,o,a,s){var n=1/(r-i),h=1/(e-o),l=1/(a-s);return t[0]=-2*n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(r+i)*n,t[13]=(o+e)*h,t[14]=(s+a)*l,t[15]=1,t};function p(){var t=new g(3);return g!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function M(t,r,i){var e=new g(3);return e[0]=t,e[1]=r,e[2]=i,e}function C(){var t=new g(4);return g!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}p(),function(){var t,r=(t=new g(4),g!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var y;p(),M(1,0,0),M(0,1,0),C(),C(),y=new g(9),g!=Float32Array&&(y[1]=0,y[2]=0,y[3]=0,y[5]=0,y[6]=0,y[7]=0),y[0]=1,y[4]=1,y[8]=1,function(){var t=function(){var t=new g(2);return g!=Float32Array&&(t[0]=0,t[1]=0),t}()}();class R{constructor(t=0,r=0){this._x=t,this._y=r}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}get magnitude(){return Math.sqrt(Math.pow(this._x,2)+Math.pow(this._y,2))}set(t,r){this._x=t,this._y=r}copy(t){this.set(t.x,t.y)}equals(t){return this._x===t.x&&this._y===t.y}clone(){return new R(this._x,this._y)}distance(t){return Math.sqrt(Math.pow(this._x-t.x,2)+Math.pow(this._y-t.y,2))}static add(t,r,i){return t.set(r.x+i.x,r.y+i.y),t}static subtract(t,r,i){return t.set(r.x-i.x,r.y-i.y),t}static unit(t,r){return 0===r.magnitude?t.set(0,0):t.set(r.x/r.magnitude,r.y/r.magnitude),t}static normal(t,r){return t.set(-r.y,r.x),this.unit(t,t)}static scale(t,r,i){return t.set(r.x*i,r.y*i),t}static dot(t,r){return t.x*r.x+t.y*r.y}static cross(t,r){return t.x*r.y-t.y*r.x}static round(t,r){return t.set(Math.round(r.x),Math.round(r.y)),t}}var A;!function(t){t[t.Polygon=0]="Polygon",t[t.Circumference=1]="Circumference",t[t.Line=2]="Line"}(A||(A={}));const v=t=>{const r=/^#?([a-f\d]{2})?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return r?{r:parseInt(r[2],16)/256,g:parseInt(r[3],16)/256,b:parseInt(r[4],16)/256,a:void 0!==r[1]?parseInt(r[1],16)/256:1}:null},_=(r,i,e)=>{var o,a;r=m(r),d(r,i.viewportRect.x,i.viewportRect.x1,i.viewportRect.y,i.viewportRect.y1,-1,1),e===t.WorldSpace?(c(r,r,[null!==(o=i.zoom)&&void 0!==o?o:1,null!==(a=i.zoom)&&void 0!==a?a:1,1]),x(r,r,[-i.positionInWorldSpace.x,-i.positionInWorldSpace.y,0])):x(r,r,[0,0,0])};class U{constructor(t,r){this.gl=t,this.programManager=r,this.vertices=new Map,this.lastVertices=null,this.projectionMatrix=u(),this.modelMatrix=u(),this.textureMatrix=u();const i=2*Math.PI/60;this.circumferenceVertices=new Float32Array(((t,r,i=1)=>{const e=[];for(let o=t;o<=r;o+=i)e.push(o);return e})(1,60,1).reduce(((t,r)=>[...t,Math.cos(r*i),Math.sin(r*i)]),[]))}render(t,r,i){switch(t.shape){case A.Polygon:this.renderLines(t,r,this.gl.LINE_LOOP,i);break;case A.Line:this.renderLines(t,r,this.gl.LINES,i);break;case A.Circumference:this.renderCircumference(t,r)}}renderLines(t,i,e,o){var a;const s=this.generateVerticesKey(t.vertexModel);!1===this.vertices.has(s)&&this.vertices.set(s,new Float32Array(this.generatePolygonVertices(t.vertexModel)));const n=this.vertices.get(s);this.lastVertices===s&&o===r.Geometric||(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,n,this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,n,this.gl.DYNAMIC_DRAW)),this.lastVertices=s,this.modelMatrix=m(this.modelMatrix),x(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),f(this.modelMatrix,this.modelMatrix,null!==(a=t.rotation)&&void 0!==a?a:0),_(this.projectionMatrix,i,t.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.uniform1i(this.programManager.renderTextureUniform,0);const{r:h,g:l,b:g,a:u}=v(t.color);this.gl.uniform4f(this.programManager.solidColorUniform,h,l,g,u),this.gl.uniform1f(this.programManager.alphaUniform,1),this.gl.drawArrays(e,0,n.length/2)}generateVerticesKey(t){return Symbol.for(t.reduce(((t,r)=>`${t}${r.x}${r.y}`),t.length.toString()))}generatePolygonVertices(t){const r=[];for(let i=0;i<t.length;i++)r.push(t[i].x,t[i].y);return r}renderCircumference(t,r){this.lastVertices=null,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.circumferenceVertices,this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.circumferenceVertices,this.gl.DYNAMIC_DRAW),this.modelMatrix=m(this.modelMatrix),x(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),c(this.modelMatrix,this.modelMatrix,[t.radius,t.radius,1]),_(this.projectionMatrix,r,t.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.uniform1i(this.programManager.renderTextureUniform,0);const{r:i,g:e,b:o,a:a}=v(t.color);this.gl.uniform4f(this.programManager.solidColorUniform,i,e,o,a),this.gl.uniform1f(this.programManager.alphaUniform,1),this.gl.drawArrays(this.gl.LINE_LOOP,0,this.circumferenceVertices.length/2)}}class T{constructor(t,i){this.gl=t,this.programManager=i,this.type=r.Mask,this.vertices=new Float32Array([-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5]),this.projectionMatrix=u(),this.modelMatrix=u(),this.textureMatrix=u()}render(t,i,e){var o,a;e!==r.Mask&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.vertices,this.gl.STATIC_DRAW)),this.modelMatrix=m(this.modelMatrix),x(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),f(this.modelMatrix,this.modelMatrix,null!==(o=t.rotation)&&void 0!==o?o:0),c(this.modelMatrix,this.modelMatrix,[t.width,t.height,1]),_(this.projectionMatrix,i,t.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),t.alpha&&t.alpha<1?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this.gl.uniform1i(this.programManager.renderTextureUniform,0);const{r:s,g:n,b:h,a:l}=v(t.color);this.gl.uniform4f(this.programManager.solidColorUniform,s,n,h,l),this.gl.uniform1f(this.programManager.alphaUniform,null!==(a=t.alpha)&&void 0!==a?a:1),this.gl.drawArrays(this.gl.TRIANGLES,0,6)}}class E{constructor(t,r,i){this.gl=t,this.programManager=r,this.textureManager=i,this.lastTexture=null,this.projectionMatrix=u(),this.modelMatrix=u(),this.textureMatrix=u(),this.posVertices=new Float32Array([-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5]),this.texVertices=new Float32Array([0,1,0,0,1,1,1,1,0,0,1,0])}render(t,r,i){var e,o,a,s;i!==t.type&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.posVertices,this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.texVertices,this.gl.STATIC_DRAW)),this.modelMatrix=m(this.modelMatrix),x(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),f(this.modelMatrix,this.modelMatrix,null!==(e=t.rotation)&&void 0!==e?e:0),c(this.modelMatrix,this.modelMatrix,[t.width*(t.flipHorizontal?-1:1),t.height*(t.flipVertical?-1:1),1]),this.textureMatrix=m(this.textureMatrix),t.slice&&(x(this.textureMatrix,this.textureMatrix,[t.slice.x/t.image.naturalWidth,t.slice.y/t.image.naturalHeight,0]),c(this.textureMatrix,this.textureMatrix,[t.slice.width/t.image.naturalWidth,t.slice.height/t.image.naturalHeight,1])),_(this.projectionMatrix,r,t.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.enable(this.gl.BLEND);const n=this.textureManager.getOrCreateTextureFromImage(t.image,t.smooth);if(this.lastTexture===n&&i===t.type||(this.gl.bindTexture(this.gl.TEXTURE_2D,n),this.gl.uniform1i(this.programManager.textureUniform,0),this.lastTexture=n),this.gl.uniform1i(this.programManager.renderTextureUniform,1),this.gl.uniform1f(this.programManager.alphaUniform,null!==(o=t.alpha)&&void 0!==o?o:1),this.gl.uniform1i(this.programManager.useTintColorUniform,t.tintColor?1:0),t.tintColor){const{r:r,g:i,b:e,a:o}=v(t.tintColor);this.gl.uniform4f(this.programManager.tintColorUniform,r,i,e,o)}if(this.gl.uniform1i(this.programManager.useMaskColorUniform,t.maskColor?1:0),t.maskColor){const{r:r,g:i,b:e}=v(t.maskColor);this.gl.uniform4f(this.programManager.maskColorUniform,r,i,e,null!==(a=t.alpha)&&void 0!==a?a:1),this.gl.uniform1f(this.programManager.maskColorMixUniform,null!==(s=t.maskColorMix)&&void 0!==s?s:1)}this.gl.drawArrays(this.gl.TRIANGLES,0,6)}}var F;!function(t){t[t.Center=0]="Center",t[t.RightUp=1]="RightUp",t[t.RightDown=2]="RightDown",t[t.RightCenter=3]="RightCenter"}(F||(F={}));const b=new R,w=[32,126,161,255],S=F.Center;class D{constructor(t,i,e,o){this.gl=t,this.programManager=i,this.textureManager=e,this.fontAtlasFactory=o,this.type=r.Text,this.posVertices=[],this.texVertices=[],this.posVerticesSize=new R,this.lastTexture=null,this.projectionMatrix=u(),this.modelMatrix=u(),this.textureMatrix=u()}render(t,i,e){if(!t.text)return;this.setDefaultValues(t);const o=this.fontAtlasFactory.getOrCreate(t.charRanges,t.font,t.bitmapSize);this.generateTextVertices(o,t),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.posVertices),this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.texVertices),this.gl.DYNAMIC_DRAW),this.modelMatrix=m(this.modelMatrix),x(this.modelMatrix,this.modelMatrix,this.getTranslationForOrientation(t)),f(this.modelMatrix,this.modelMatrix,t.rotation),this.textureMatrix=m(this.textureMatrix),c(this.textureMatrix,this.textureMatrix,[1/o.canvas.width,1/o.canvas.height,1]),_(this.projectionMatrix,i,t.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),t.opacity<1?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND);const a=this.textureManager.getOrCreateTextureFromCanvas(o.fontFace.family,o.canvas,t.smooth);this.lastTexture===a&&e===r.Text||(this.gl.bindTexture(this.gl.TEXTURE_2D,a),this.gl.uniform1i(this.programManager.textureUniform,0),this.lastTexture=a),this.gl.uniform1i(this.programManager.useTintColorUniform,0),this.gl.uniform1i(this.programManager.renderTextureUniform,1),this.gl.uniform1f(this.programManager.alphaUniform,t.opacity);const{r:s,g:n,b:h,a:l}=v(t.color);this.gl.uniform4f(this.programManager.maskColorUniform,s,n,h,l),this.gl.uniform1f(this.programManager.maskColorMixUniform,1),this.gl.uniform1i(this.programManager.useMaskColorUniform,1),this.gl.drawArrays(this.gl.TRIANGLES,0,this.posVertices.length/2)}setDefaultValues(t){var r,i,e,o,a,s,n,h,l;t.bitmapOffset=null!==(r=t.bitmapOffset)&&void 0!==r?r:b,t.bitmapSize=null!==(i=t.bitmapSize)&&void 0!==i?i:64,t.charRanges=null!==(e=t.charRanges)&&void 0!==e?e:w,t.color=null!==(o=t.color)&&void 0!==o?o:"#000000",t.letterSpacing=null!==(a=t.letterSpacing)&&void 0!==a?a:0,t.lineSeparation=null!==(s=t.lineSeparation)&&void 0!==s?s:0,t.opacity=null!==(n=t.opacity)&&void 0!==n?n:1,t.orientation=null!==(h=t.orientation)&&void 0!==h?h:S,t.rotation=null!==(l=t.rotation)&&void 0!==l?l:0}generateTextVertices(t,r){this.posVertices=[],this.texVertices=[];const i=this.getDimensions(r),e={x1:-i.width/2,y1:i.height/2-r.fontSize,x2:0,y2:i.height/2},o={x1:0,y1:0,x2:0,y2:0};for(let a=0;a<r.text.length;a++){const s=r.text[a];if("\n"===s){e.y1-=r.fontSize+r.lineSeparation,e.y2=e.y1+r.fontSize,e.x1=-i.width/2;continue}if(" "===s){e.x1+=r.fontSize+r.letterSpacing;continue}const n=t.glyphsData.get(s);n&&(e.x2=e.x1+r.fontSize,o.x1=n.x+r.bitmapOffset.x,o.y1=n.y+r.bitmapOffset.y,o.x2=n.x+n.width-1,o.y2=n.y+n.height-1,this.posVertices.push(e.x1,e.y1,e.x2,e.y1,e.x1,e.y2,e.x1,e.y2,e.x2,e.y1,e.x2,e.y2),this.texVertices.push(o.x1,o.y2,o.x2,o.y2,o.x1,o.y1,o.x1,o.y1,o.x2,o.y2,o.x2,o.y1)),e.x1+=r.fontSize+r.letterSpacing}this.posVerticesSize.set(i.width,i.height)}getDimensions(t){return t.text.split("\n").reduce(((r,i,e)=>(r.width=Math.max(r.width,i.length*(t.fontSize+t.letterSpacing)),r.height+=t.fontSize+Math.min(e,1)*t.lineSeparation,r)),{width:0,height:0})}getTranslationForOrientation(t){return[t.position.x+(t.orientation===F.Center?0:this.posVerticesSize.x/2),t.position.y+(t.orientation===F.RightDown?-this.posVerticesSize.y/2:t.orientation===F.RightUp?this.posVerticesSize.y:0),0]}}class B{constructor(t,r,i){this.gl=t,this.programManager=r,this.textureManager=i,this.posVertices=[],this.texVertices=[],this.lastTexture=null,this.projectionMatrix=u(),this.modelMatrix=u(),this.textureMatrix=u()}render(t,i,e){var o,a;this.generateVertices(t),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.posVertices),this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.texVertices),this.gl.DYNAMIC_DRAW),this.modelMatrix=m(this.modelMatrix),x(this.modelMatrix,this.modelMatrix,[t.position.x-t.tilemap.width*t.tilemap.tileWidth/2,t.position.y+Math.floor(t.tiles.length/t.tilemap.width)*t.tilemap.tileHeight/2,0]),f(this.modelMatrix,this.modelMatrix,null!==(o=t.rotation)&&void 0!==o?o:0),c(this.modelMatrix,this.modelMatrix,[t.tilemap.tileWidth,t.tilemap.tileHeight,1]),this.textureMatrix=m(this.textureMatrix),c(this.textureMatrix,this.textureMatrix,[t.tileset.tileWidth/t.image.naturalWidth,t.tileset.tileHeight/t.image.naturalHeight,1]),_(this.projectionMatrix,i,t.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.enable(this.gl.BLEND);const s=this.textureManager.getOrCreateTextureFromImage(t.image,t.smooth);if(this.lastTexture===s&&e===r.Tilemap||(this.gl.bindTexture(this.gl.TEXTURE_2D,s),this.gl.uniform1i(this.programManager.textureUniform,0),this.lastTexture=s),this.gl.uniform1i(this.programManager.useMaskColorUniform,0),this.gl.uniform1i(this.programManager.renderTextureUniform,1),this.gl.uniform1f(this.programManager.alphaUniform,null!==(a=t.alpha)&&void 0!==a?a:1),this.gl.uniform1i(this.programManager.useTintColorUniform,t.tintColor?1:0),t.tintColor){const{r:r,g:i,b:e,a:o}=v(t.tintColor);this.gl.uniform4f(this.programManager.tintColorUniform,r,i,e,o)}this.gl.drawArrays(this.gl.TRIANGLES,0,this.posVertices.length/2)}generateVertices(t){this.posVertices=[],this.texVertices=[];let r=0;t.tiles.forEach(((i,e)=>{if(0===i)return;const o=e%t.tilemap.width;r=e>0&&0===o?r-1:r,this.posVertices.push(o,r-1,o+1,r-1,o,r,o,r,o+1,r-1,o+1,r);const a=(i-1)%t.tileset.width,s=Math.floor((i-1)/t.tileset.width);this.texVertices.push(a,s+1,a+1,s+1,a,s,a,s,a+1,s+1,a+1,s)}))}}class L{constructor(t){this.gl=t}createFromImage(t,r=!0,i=null){return i=null!=i?i:this.gl.createTexture(),t.naturalWidth?this.create(t,i,r):t.addEventListener("load",(()=>this.create(t,i,r))),i}createFromCanvas(t,r=!0,i=null){return i=null!=i?i:this.gl.createTexture(),this.create(t,i,r),i}create(t,r,i=!0){this.gl.bindTexture(this.gl.TEXTURE_2D,r),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),!1===i?(this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST)):(this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR)),this.gl.bindTexture(this.gl.TEXTURE_2D,null)}}class V{constructor(t){this.textureFactory=t,this.textures=new Map}getOrCreateTextureFromImage(t,r=!0){var i;return null!==(i=this.textures.get(Symbol.for(t.src)))&&void 0!==i?i:this.createTextureFromImage(t,r)}createTextureFromImage(t,r=!0){const i=this.textureFactory.createFromImage(t,r);return this.textures.set(Symbol.for(t.src),i),i}getOrCreateTextureFromCanvas(t,r,i=!0){var e;return null!==(e=this.textures.get(Symbol.for(t)))&&void 0!==e?e:this.createTextureFromCanvas(t,r,i)}createTextureFromCanvas(t,r,i=!0){const e=this.textureFactory.createFromCanvas(r,i);return this.textures.set(Symbol.for(t),e),e}}class I{constructor(t,r,i){this.gl=t,this.renderers=i,r.loadProgram()}render(t,r){this.renderers.get(t.type).render(t,r,this.lastRender),this.lastRender=t.type}clearCanvas(t){const r=v(t);this.gl.clearColor(r.r,r.g,r.b,r.a),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}}var P;!function(t){t[t.Center=0]="Center",t[t.RightUp=1]="RightUp",t[t.RightDown=2]="RightDown",t[t.RightCenter=3]="RightCenter"}(P||(P={}));const k=t=>{const i=new o(t),s=i.gl,g=i.contextVersion,u=new h(s,g,new n(s,new l(s))),m=new V(new L(s)),x=new I(s,u,new Map([[r.Sprite,new E(s,u,m)],[r.Text,new D(s,u,m,new a)],[r.Tilemap,new B(s,u,m)],[r.Geometric,new U(s,u)],[r.Mask,new T(s,u)]]));return new e(x)};export{A as GeometricShape,r as RenderDataType,t as RenderLocation,F as TextOrientation,P as TilemapOrientation,k as renderManagerFactory};
