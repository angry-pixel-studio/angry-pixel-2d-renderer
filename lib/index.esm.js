var t,i,r,e;!function(t){t[t.Polygon=0]="Polygon",t[t.Circumference=1]="Circumference",t[t.Line=2]="Line"}(t||(t={})),function(t){t[t.WorldSpace=0]="WorldSpace",t[t.ViewPort=1]="ViewPort"}(i||(i={})),function(t){t[t.Sprite=0]="Sprite",t[t.Text=1]="Text",t[t.Tilemap=2]="Tilemap",t[t.Mask=3]="Mask",t[t.Geometric=4]="Geometric"}(r||(r={}));class s{constructor(t){this.gl=t,this.viewport={x:0,x1:0,y:0,y1:0},this.object={x:0,x1:0,y:0,y1:0}}setViewport(t,r){r===i.WorldSpace?(this.viewport.x=t.position.x-this.gl.canvas.width/2,this.viewport.x1=t.position.x+this.gl.canvas.width/2,this.viewport.y=t.position.y-this.gl.canvas.height/2,this.viewport.y1=t.position.y+this.gl.canvas.height/2):(this.viewport.x=-this.gl.canvas.width/2,this.viewport.x1=this.gl.canvas.width/2,this.viewport.y=-this.gl.canvas.height/2,this.viewport.y1=this.gl.canvas.height/2)}setObjectForResizeable({position:t,width:i,height:r,rotation:e=0}){const s=Math.sin(e)*r+Math.cos(e)*i,o=Math.sin(e)*i+Math.cos(e)*r;this.object.x=t.x-s/2,this.object.x1=t.x+s/2,this.object.y=t.y-o/2,this.object.y1=t.y+o/2}setObjectForText({position:t,text:i,fontSize:r,lineSeparation:e,letterSpacing:s,rotation:o}){const a=i.split("\n").reduce(((t,i)=>Math.max(t,i.length)),0)*(r+(null!=s?s:0)),n=i.split("\n").length*(r+(null!=e?e:0));this.setObjectForResizeable({position:t,width:a,height:n,rotation:o})}setObjectForGeometric({position:i,vertexModel:r,shape:e,radius:s}){e===t.Circumference?(this.object.x=i.x-s,this.object.y=i.y-s,this.object.x1=i.x+s,this.object.y1=i.y+s):(this.object.x=Number.MAX_SAFE_INTEGER,this.object.y=Number.MAX_SAFE_INTEGER,this.object.x1=Number.MIN_SAFE_INTEGER,this.object.y1=Number.MIN_SAFE_INTEGER,r.forEach((t=>{this.object.x=Math.min(t.x+i.x,this.object.x),this.object.y=Math.min(t.y+i.y,this.object.y),this.object.x1=Math.max(t.x+i.x,this.object.x1),this.object.y1=Math.max(t.y+i.y,this.object.y1)})))}setObjectForTilemap({position:t,tilemap:i,tiles:r,rotation:e}){this.setObjectForResizeable({position:t,width:i.width*i.tileWidth,height:r.length/i.width*i.tileHeight,rotation:e})}applyCullingInTiles({tiles:t,tilemap:{width:i,tileWidth:r,tileHeight:e}}){return t.map(((t,s)=>this.viewport.x1>=this.object.x+s%i*r&&this.viewport.x<=this.object.x+s%i*r+r&&this.viewport.y1>=this.object.y1-((s/i|0)*e+e)&&this.viewport.y<=this.object.y1-(s/i|0)*e?t:0))}isInViewPort(t,i){switch(this.setViewport(i,t.location),t.type){case r.Mask:case r.Sprite:this.setObjectForResizeable(t);break;case r.Geometric:this.setObjectForGeometric(t);break;case r.Text:this.setObjectForText(t);break;case r.Tilemap:this.setObjectForTilemap(t)}return this.viewport.x1>=this.object.x&&this.viewport.x<=this.object.x1&&this.viewport.y1>=this.object.y&&this.viewport.y<=this.object.y1}applyCulling(t,i){return i.filter((i=>!!this.isInViewPort(i,t)&&(i.type===r.Tilemap&&(i.culledTiles=this.applyCullingInTiles(i)),!0)))}}class o{constructor(t,i){this.webglManager=t,this.cullingManager=i,this.renderData=[],this.cameraData=[]}addRenderData(t){this.renderData.push(t)}addCameraData(t){this.cameraData.push(t)}render(){this.cameraData.sort(((t,i)=>t.depth-i.depth)).forEach((t=>this.renderByCamera(t)))}renderByCamera(t){this.cullingManager.applyCulling(t,this.renderData.filter((i=>t.layers.includes(i.layer))).sort(((i,r)=>t.layers.indexOf(i.layer)-t.layers.indexOf(r.layer)))).forEach((i=>this.webglManager.render(i,t)))}clearData(){this.renderData=[],this.cameraData=[]}clearScreen(t){this.webglManager.clearCanvas(t)}}!function(t){t.LegacyWebGL="webgl",t.WebGL2="webgl2"}(e||(e={}));class a{constructor(t){if(this.canvas=t,this.contextVersion=this.getContextVersion(),!this.contextVersion)throw new Error("Your browser does not support WebGL.");this.gl=this.canvas.getContext(this.contextVersion)}getContextVersion(){return null!==this.canvas.getContext(e.WebGL2)?e.WebGL2:null!==this.canvas.getContext(e.LegacyWebGL)?e.LegacyWebGL:void 0}}class n{constructor(){this.fontAtlas=new Map}hasFontAtlas(t){return this.fontAtlas.has(Symbol.for(t.family))}getFontAtlas(t){return this.fontAtlas.get(Symbol.for(t.family))}getOrCreate(t,i,r){var e;return null!==(e=this.getFontAtlas(i))&&void 0!==e?e:this.create(t,i,r)}create(t,i,r){this.bitmapSize=r,this.chars=[];for(let i=0;i<t.length;i+=2)for(let r=t[i];r<=t[i+1];r++)this.chars.push(String.fromCharCode(r));const e=this.renderAtlas(i);return this.fontAtlas.set(Symbol.for(i.family),e),e}renderAtlas(t){const i=new h(t,this.bitmapSize,this.bitmapSize);i.canvas.width=Math.round(Math.sqrt(this.chars.length))*this.bitmapSize,i.canvas.height=i.canvas.width;const r=i.canvas.getContext("2d");r.clearRect(0,0,i.canvas.width,i.canvas.height),r.textBaseline="top",r.fillStyle="#000",r.font=`${this.bitmapSize}px ${t.family}`;let e=0,s=0;for(let t=0;t<this.chars.length;t++)r.fillText(this.chars[t],e,s),i.glyphsData.set(this.chars[t],{x:e,y:s}),(e+=this.bitmapSize)>i.canvas.width-this.bitmapSize&&(e=0,s+=this.bitmapSize);return i}}class h{constructor(t,i,r){this.fontFace=t,this.glyphWidth=i,this.glyphHeight=r,this.canvas=document.createElement("canvas"),this.glyphsData=new Map}}class l{constructor(t,i){this.gl=t,this.shaderLoader=i}create(t,i){const r=this.gl.createProgram(),e=this.shaderLoader.load(this.gl.VERTEX_SHADER,t),s=this.shaderLoader.load(this.gl.FRAGMENT_SHADER,i);this.gl.attachShader(r,e),this.gl.attachShader(r,s),this.gl.linkProgram(r);const o=this.gl.LINK_STATUS;if(!this.gl.getProgramParameter(r,o)){const t=this.gl.getProgramInfoLog(r);throw this.gl.deleteProgram(r),new Error(`Unable to initialize the Program: ${t}`)}return r}}class g{constructor(t,i,r){this.gl=t,this.contextVersion=i,this.programFactory=r}loadProgram(){this.program=this.contextVersion===e.WebGL2?this.programFactory.create("#version 300 es\nprecision mediump float;\n\nin vec2 positionCoords;\nin vec2 textureCoords;\n\nout vec2 texCoords;\n\nuniform mat4 projectionMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 textureMatrix;\n\nvoid main()\n{\n    gl_Position = projectionMatrix * modelMatrix * vec4(positionCoords, 0, 1);\n    texCoords = (textureMatrix * vec4(textureCoords, 0, 1)).xy;\n}","#version 300 es\nprecision mediump float;\n\nout vec4 fragColor;\n\nin vec2 texCoords;\n\nuniform int u_renderTexture;\nuniform sampler2D u_texImage;\nuniform vec4 u_solidColor;\n\nuniform int u_useTintColor;\nuniform vec4 u_tintColor;\n\nuniform int u_useMaskColor;\nuniform vec4 u_maskColor;\nuniform float u_maskColorMix;\n\nuniform float u_alpha;\n\nvoid main()\n{\n    if (u_renderTexture == 1) {\n        vec4 texColor = texture(u_texImage, texCoords);\n\n        if (texColor.a < 0.0001) {\n            discard;\n        }\n\n        if (u_useTintColor == 1) {\n            texColor = u_tintColor * texColor;\n        }\n\n        if (u_useMaskColor == 1) {\n            texColor = mix(texColor, u_maskColor, clamp(u_maskColorMix, 0.0, 1.0));\n        }\n\n        fragColor = vec4(texColor.rgb, u_alpha * texColor.a);        \n    } else {\n        fragColor = vec4(u_solidColor.rgb, u_alpha);\n    }\n}"):this.programFactory.create("precision mediump float;\n\nattribute vec2 positionCoords;\nattribute vec2 textureCoords;\n\nvarying vec2 texCoords;\n\nuniform mat4 projectionMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 textureMatrix;\n\nvoid main()\n{\n    gl_Position = projectionMatrix * modelMatrix * vec4(positionCoords, 0, 1);\n    texCoords = (textureMatrix * vec4(textureCoords, 0, 1)).xy;\n}","precision mediump float;\n\nvarying vec2 texCoords;\n\nuniform int u_renderTexture;\nuniform sampler2D u_texImage;\nuniform vec4 u_solidColor;\n\nuniform int u_useTintColor;\nuniform vec4 u_tintColor;\n\nuniform int u_useMaskColor;\nuniform vec4 u_maskColor;\nuniform float u_maskColorMix;\n\nuniform float u_alpha;\n\nvoid main()\n{\n    if (u_renderTexture == 1) {\n        vec4 texColor = texture2D(u_texImage, texCoords);\n\n        if (texColor.a < 0.0001) {\n            discard;\n        }\n\n        if (u_useTintColor == 1) {\n            texColor = u_tintColor * texColor;\n        }\n\n        if (u_useMaskColor == 1) {\n            texColor = mix(texColor, u_maskColor, clamp(u_maskColorMix, 0.0, 1.0));\n        }\n\n        gl_FragColor = vec4(texColor.rgb, u_alpha * texColor.a);\n    } else {\n        gl_FragColor =  vec4(u_solidColor.rgb, u_alpha);\n    }\n}"),this.positionBuffer=this.gl.createBuffer(),this.textureBuffer=this.gl.createBuffer(),this.positionCoordsAttr=this.gl.getAttribLocation(this.program,"positionCoords"),this.texCoordsAttr=this.gl.getAttribLocation(this.program,"textureCoords"),this.modelMatrixUniform=this.gl.getUniformLocation(this.program,"modelMatrix"),this.projectionMatrixUniform=this.gl.getUniformLocation(this.program,"projectionMatrix"),this.textureMatrixUniform=this.gl.getUniformLocation(this.program,"textureMatrix"),this.renderTextureUniform=this.gl.getUniformLocation(this.program,"u_renderTexture"),this.textureUniform=this.gl.getUniformLocation(this.program,"u_texImage"),this.solidColorUniform=this.gl.getUniformLocation(this.program,"u_solidColor"),this.useTintColorUniform=this.gl.getUniformLocation(this.program,"u_useTintColor"),this.tintColorUniform=this.gl.getUniformLocation(this.program,"u_tintColor"),this.useMaskColorUniform=this.gl.getUniformLocation(this.program,"u_useMaskColor"),this.maskColorUniform=this.gl.getUniformLocation(this.program,"u_maskColor"),this.maskColorMixUniform=this.gl.getUniformLocation(this.program,"u_maskColorMix"),this.alphaUniform=this.gl.getUniformLocation(this.program,"u_alpha"),this.gl.useProgram(this.program),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enableVertexAttribArray(this.positionCoordsAttr),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.vertexAttribPointer(this.positionCoordsAttr,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.texCoordsAttr),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureBuffer),this.gl.vertexAttribPointer(this.texCoordsAttr,2,this.gl.FLOAT,!1,0,0)}}class c{constructor(t){this.gl=t}load(t,i){const r=this.gl.createShader(t);this.gl.shaderSource(r,i),this.gl.compileShader(r);const e=this.gl.COMPILE_STATUS;if(!this.gl.getShaderParameter(r,e)){const t=this.gl.getShaderInfoLog(r);throw this.gl.deleteShader(r),new Error(`Unable to initialize the shader program: ${t}`)}return r}}var u="undefined"!=typeof Float32Array?Float32Array:Array;function m(){var t=new u(16);return u!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function x(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function f(t,i,r){var e,s,o,a,n,h,l,g,c,u,m,x,f=r[0],p=r[1],d=r[2];return i===t?(t[12]=i[0]*f+i[4]*p+i[8]*d+i[12],t[13]=i[1]*f+i[5]*p+i[9]*d+i[13],t[14]=i[2]*f+i[6]*p+i[10]*d+i[14],t[15]=i[3]*f+i[7]*p+i[11]*d+i[15]):(e=i[0],s=i[1],o=i[2],a=i[3],n=i[4],h=i[5],l=i[6],g=i[7],c=i[8],u=i[9],m=i[10],x=i[11],t[0]=e,t[1]=s,t[2]=o,t[3]=a,t[4]=n,t[5]=h,t[6]=l,t[7]=g,t[8]=c,t[9]=u,t[10]=m,t[11]=x,t[12]=e*f+n*p+c*d+i[12],t[13]=s*f+h*p+u*d+i[13],t[14]=o*f+l*p+m*d+i[14],t[15]=a*f+g*p+x*d+i[15]),t}function p(t,i,r){var e=r[0],s=r[1],o=r[2];return t[0]=i[0]*e,t[1]=i[1]*e,t[2]=i[2]*e,t[3]=i[3]*e,t[4]=i[4]*s,t[5]=i[5]*s,t[6]=i[6]*s,t[7]=i[7]*s,t[8]=i[8]*o,t[9]=i[9]*o,t[10]=i[10]*o,t[11]=i[11]*o,t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],t}function d(t,i,r){var e=Math.sin(r),s=Math.cos(r),o=i[0],a=i[1],n=i[2],h=i[3],l=i[4],g=i[5],c=i[6],u=i[7];return i!==t&&(t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15]),t[0]=o*s+l*e,t[1]=a*s+g*e,t[2]=n*s+c*e,t[3]=h*s+u*e,t[4]=l*s-o*e,t[5]=g*s-a*e,t[6]=c*s-n*e,t[7]=u*s-h*e,t}Math.hypot||(Math.hypot=function(){for(var t=0,i=arguments.length;i--;)t+=arguments[i]*arguments[i];return Math.sqrt(t)});var M=function(t,i,r,e,s,o,a){var n=1/(i-r),h=1/(e-s),l=1/(o-a);return t[0]=-2*n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(i+r)*n,t[13]=(s+e)*h,t[14]=(a+o)*l,t[15]=1,t};function y(){var t=new u(3);return u!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function C(t,i,r){var e=new u(3);return e[0]=t,e[1]=i,e[2]=r,e}function v(){var t=new u(4);return u!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}y(),function(){var t,i=(t=new u(4),u!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var R;y(),C(1,0,0),C(0,1,0),v(),v(),R=new u(9),u!=Float32Array&&(R[1]=0,R[2]=0,R[3]=0,R[5]=0,R[6]=0,R[7]=0),R[0]=1,R[4]=1,R[8]=1,function(){var t=function(){var t=new u(2);return u!=Float32Array&&(t[0]=0,t[1]=0),t}()}();class A{constructor(t=0,i=0){this._x=t,this._y=i}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}get magnitude(){return Math.sqrt(Math.pow(this._x,2)+Math.pow(this._y,2))}set(t,i){this._x=t,this._y=i}copy(t){this.set(t.x,t.y)}equals(t){return this._x===t.x&&this._y===t.y}clone(){return new A(this._x,this._y)}distance(t){return Math.sqrt(Math.pow(this._x-t.x,2)+Math.pow(this._y-t.y,2))}static add(t,i,r){return t.set(i.x+r.x,i.y+r.y),t}static subtract(t,i,r){return t.set(i.x-r.x,i.y-r.y),t}static unit(t,i){return 0===i.magnitude?t.set(0,0):t.set(i.x/i.magnitude,i.y/i.magnitude),t}static normal(t,i){return t.set(-i.y,i.x),this.unit(t,t)}static scale(t,i,r){return t.set(i.x*r,i.y*r),t}static dot(t,i){return t.x*i.x+t.y*i.y}static cross(t,i){return t.x*i.y-t.y*i.x}static round(t,i){return t.set(Math.round(i.x),Math.round(i.y)),t}}const b=t=>{const i=/^#?([a-f\d]{2})?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[2],16)/256,g:parseInt(i[3],16)/256,b:parseInt(i[4],16)/256,a:void 0!==i[1]?parseInt(i[1],16)/256:1}:null},_=(t,r,e,s)=>{var o,a;t=x(t),M(t,-r.canvas.width/2,r.canvas.width/2,-r.canvas.height/2,r.canvas.height/2,-1,1),s===i.WorldSpace?(p(t,t,[null!==(o=e.zoom)&&void 0!==o?o:1,null!==(a=e.zoom)&&void 0!==a?a:1,1]),f(t,t,[-e.position.x,-e.position.y,0])):f(t,t,[0,0,0])};class T{constructor(t,i){this.gl=t,this.programManager=i,this.vertices=new Map,this.lastVertices=null,this.projectionMatrix=m(),this.modelMatrix=m(),this.textureMatrix=m();const r=2*Math.PI/60;this.circumferenceVertices=new Float32Array(((t,i,r=1)=>{const e=[];for(let s=t;s<=i;s+=r)e.push(s);return e})(1,60,1).reduce(((t,i)=>[...t,Math.cos(i*r),Math.sin(i*r)]),[]))}render(i,r,e){switch(i.shape){case t.Polygon:this.renderLines(i,r,this.gl.LINE_LOOP,e);break;case t.Line:this.renderLines(i,r,this.gl.LINES,e);break;case t.Circumference:this.renderCircumference(i,r)}}renderLines(t,i,e,s){var o;const a=this.generateVerticesKey(t.vertexModel);!1===this.vertices.has(a)&&this.vertices.set(a,new Float32Array(this.generatePolygonVertices(t.vertexModel)));const n=this.vertices.get(a);this.lastVertices===a&&s===r.Geometric||(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,n,this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,n,this.gl.DYNAMIC_DRAW)),this.lastVertices=a,this.modelMatrix=x(this.modelMatrix),f(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),d(this.modelMatrix,this.modelMatrix,null!==(o=t.rotation)&&void 0!==o?o:0),_(this.projectionMatrix,this.gl,i,t.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.uniform1i(this.programManager.renderTextureUniform,0);const{r:h,g:l,b:g,a:c}=b(t.color);this.gl.uniform4f(this.programManager.solidColorUniform,h,l,g,c),this.gl.uniform1f(this.programManager.alphaUniform,1),this.gl.drawArrays(e,0,n.length/2)}generateVerticesKey(t){return Symbol.for(t.reduce(((t,i)=>`${t}${i.x}${i.y}`),t.length.toString()))}generatePolygonVertices(t){const i=[];for(let r=0;r<t.length;r++)i.push(t[r].x,t[r].y);return i}renderCircumference(t,i){this.lastVertices=null,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.circumferenceVertices,this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.circumferenceVertices,this.gl.DYNAMIC_DRAW),this.modelMatrix=x(this.modelMatrix),f(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),p(this.modelMatrix,this.modelMatrix,[t.radius,t.radius,1]),_(this.projectionMatrix,this.gl,i,t.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.uniform1i(this.programManager.renderTextureUniform,0);const{r:r,g:e,b:s,a:o}=b(t.color);this.gl.uniform4f(this.programManager.solidColorUniform,r,e,s,o),this.gl.uniform1f(this.programManager.alphaUniform,1),this.gl.drawArrays(this.gl.LINE_LOOP,0,this.circumferenceVertices.length/2)}}class w{constructor(t,i){this.gl=t,this.programManager=i,this.type=r.Mask,this.vertices=new Float32Array([-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5]),this.projectionMatrix=m(),this.modelMatrix=m(),this.textureMatrix=m()}render(t,i,e){var s,o;e!==r.Mask&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.vertices,this.gl.STATIC_DRAW)),this.modelMatrix=x(this.modelMatrix),f(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),d(this.modelMatrix,this.modelMatrix,null!==(s=t.rotation)&&void 0!==s?s:0),p(this.modelMatrix,this.modelMatrix,[t.width,t.height,1]),_(this.projectionMatrix,this.gl,i,t.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),t.alpha&&t.alpha<1?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this.gl.uniform1i(this.programManager.renderTextureUniform,0);const{r:a,g:n,b:h,a:l}=b(t.color);this.gl.uniform4f(this.programManager.solidColorUniform,a,n,h,l),this.gl.uniform1f(this.programManager.alphaUniform,null!==(o=t.alpha)&&void 0!==o?o:1),this.gl.drawArrays(this.gl.TRIANGLES,0,6)}}class U{constructor(t,i,r){this.gl=t,this.programManager=i,this.textureManager=r,this.lastTexture=null,this.projectionMatrix=m(),this.modelMatrix=m(),this.textureMatrix=m(),this.posVertices=new Float32Array([-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,.5]),this.texVertices=new Float32Array([0,1,0,0,1,1,1,1,0,0,1,0])}render(t,i,r){var e,s,o,a;r!==t.type&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.posVertices,this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.texVertices,this.gl.STATIC_DRAW)),this.modelMatrix=x(this.modelMatrix),f(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),d(this.modelMatrix,this.modelMatrix,null!==(e=t.rotation)&&void 0!==e?e:0),p(this.modelMatrix,this.modelMatrix,[t.width*(t.flipHorizontal?-1:1),t.height*(t.flipVertical?-1:1),1]),this.textureMatrix=x(this.textureMatrix),t.slice&&(f(this.textureMatrix,this.textureMatrix,[t.slice.x/t.image.naturalWidth,t.slice.y/t.image.naturalHeight,0]),p(this.textureMatrix,this.textureMatrix,[t.slice.width/t.image.naturalWidth,t.slice.height/t.image.naturalHeight,1])),_(this.projectionMatrix,this.gl,i,t.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.enable(this.gl.BLEND);const n=this.textureManager.getOrCreateTextureFromImage(t.image,t.smooth);if(this.lastTexture===n&&r===t.type||(this.gl.bindTexture(this.gl.TEXTURE_2D,n),this.gl.uniform1i(this.programManager.textureUniform,0),this.lastTexture=n),this.gl.uniform1i(this.programManager.renderTextureUniform,1),this.gl.uniform1f(this.programManager.alphaUniform,null!==(s=t.alpha)&&void 0!==s?s:1),this.gl.uniform1i(this.programManager.useTintColorUniform,t.tintColor?1:0),t.tintColor){const{r:i,g:r,b:e,a:s}=b(t.tintColor);this.gl.uniform4f(this.programManager.tintColorUniform,i,r,e,s)}if(this.gl.uniform1i(this.programManager.useMaskColorUniform,t.maskColor?1:0),t.maskColor){const{r:i,g:r,b:e}=b(t.maskColor);this.gl.uniform4f(this.programManager.maskColorUniform,i,r,e,null!==(o=t.alpha)&&void 0!==o?o:1),this.gl.uniform1f(this.programManager.maskColorMixUniform,null!==(a=t.maskColorMix)&&void 0!==a?a:1)}this.gl.drawArrays(this.gl.TRIANGLES,0,6)}}var E;!function(t){t[t.Center=0]="Center",t[t.RightUp=1]="RightUp",t[t.RightDown=2]="RightDown",t[t.RightCenter=3]="RightCenter"}(E||(E={}));const F=new A,S=[32,126,161,255],D=E.Center;class j{constructor(t,i,e,s){this.gl=t,this.programManager=i,this.textureManager=e,this.fontAtlasFactory=s,this.type=r.Text,this.posVertices=[],this.texVertices=[],this.posVerticesSize=new A,this.lastTexture=null,this.projectionMatrix=m(),this.modelMatrix=m(),this.textureMatrix=m()}render(t,i,e){if(!t.text)return;this.setDefaultValues(t);const s=this.fontAtlasFactory.getOrCreate(t.charRanges,t.font,t.bitmapSize);this.generateTextVertices(s,t),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.posVertices),this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.texVertices),this.gl.DYNAMIC_DRAW),this.modelMatrix=x(this.modelMatrix),f(this.modelMatrix,this.modelMatrix,this.getTranslationForOrientation(t)),d(this.modelMatrix,this.modelMatrix,t.rotation),this.textureMatrix=x(this.textureMatrix),p(this.textureMatrix,this.textureMatrix,[1/s.canvas.width,1/s.canvas.height,1]),_(this.projectionMatrix,this.gl,i,t.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),t.opacity<1?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND);const o=this.textureManager.getOrCreateTextureFromCanvas(s.fontFace.family,s.canvas,t.smooth);this.lastTexture===o&&e===r.Text||(this.gl.bindTexture(this.gl.TEXTURE_2D,o),this.gl.uniform1i(this.programManager.textureUniform,0),this.lastTexture=o),this.gl.uniform1i(this.programManager.useTintColorUniform,0),this.gl.uniform1i(this.programManager.renderTextureUniform,1),this.gl.uniform1f(this.programManager.alphaUniform,t.opacity);const{r:a,g:n,b:h,a:l}=b(t.color);this.gl.uniform4f(this.programManager.maskColorUniform,a,n,h,l),this.gl.uniform1f(this.programManager.maskColorMixUniform,1),this.gl.uniform1i(this.programManager.useMaskColorUniform,1),this.gl.drawArrays(this.gl.TRIANGLES,0,this.posVertices.length/2)}setDefaultValues(t){var i,r,e,s,o,a,n,h,l;t.bitmapOffset=null!==(i=t.bitmapOffset)&&void 0!==i?i:F,t.bitmapSize=null!==(r=t.bitmapSize)&&void 0!==r?r:64,t.charRanges=null!==(e=t.charRanges)&&void 0!==e?e:S,t.color=null!==(s=t.color)&&void 0!==s?s:"#000000",t.letterSpacing=null!==(o=t.letterSpacing)&&void 0!==o?o:0,t.lineSeparation=null!==(a=t.lineSeparation)&&void 0!==a?a:0,t.opacity=null!==(n=t.opacity)&&void 0!==n?n:1,t.orientation=null!==(h=t.orientation)&&void 0!==h?h:D,t.rotation=null!==(l=t.rotation)&&void 0!==l?l:0}generateTextVertices(t,i){this.posVertices=[],this.texVertices=[];const r=this.getDimensions(i),e={x1:-r.width/2,y1:r.height/2-i.fontSize,x2:0,y2:r.height/2},s={x1:0,y1:0,x2:0,y2:0};for(let o=0;o<i.text.length;o++){const a=i.text[o];if("\n"===a){e.y1-=i.fontSize+i.lineSeparation,e.y2=e.y1+i.fontSize,e.x1=-r.width/2;continue}if(" "===a){e.x1+=i.fontSize+i.letterSpacing;continue}const n=t.glyphsData.get(a);n&&(e.x2=e.x1+i.fontSize,s.x1=n.x+i.bitmapOffset.x,s.y1=n.y+i.bitmapOffset.y,s.x2=n.x+t.glyphWidth-1,s.y2=n.y+t.glyphHeight-1,this.posVertices.push(e.x1,e.y1,e.x2,e.y1,e.x1,e.y2,e.x1,e.y2,e.x2,e.y1,e.x2,e.y2),this.texVertices.push(s.x1,s.y2,s.x2,s.y2,s.x1,s.y1,s.x1,s.y1,s.x2,s.y2,s.x2,s.y1)),e.x1+=i.fontSize+i.letterSpacing}this.posVerticesSize.set(r.width,r.height)}getDimensions(t){return t.text.split("\n").reduce(((i,r,e)=>(i.width=Math.max(i.width,r.length*(t.fontSize+t.letterSpacing)),i.height+=t.fontSize+Math.min(e,1)*t.lineSeparation,i)),{width:0,height:0})}getTranslationForOrientation(t){return[t.position.x+(t.orientation===E.Center?0:this.posVerticesSize.x/2),t.position.y+(t.orientation===E.RightDown?-this.posVerticesSize.y/2:t.orientation===E.RightUp?this.posVerticesSize.y:0),0]}}class B{constructor(t,i,r){this.gl=t,this.programManager=i,this.textureManager=r,this.posVertices=[],this.texVertices=[],this.lastTexture=null,this.projectionMatrix=m(),this.modelMatrix=m(),this.textureMatrix=m()}render(t,i,e){var s,o;this.generateVertices(t),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.posVertices),this.gl.DYNAMIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.programManager.textureBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(this.texVertices),this.gl.DYNAMIC_DRAW),this.modelMatrix=x(this.modelMatrix),f(this.modelMatrix,this.modelMatrix,[t.position.x,t.position.y,0]),d(this.modelMatrix,this.modelMatrix,null!==(s=t.rotation)&&void 0!==s?s:0),p(this.modelMatrix,this.modelMatrix,[t.tilemap.tileWidth,t.tilemap.tileHeight,1]),this.textureMatrix=x(this.textureMatrix),p(this.textureMatrix,this.textureMatrix,[t.tileset.tileWidth/t.image.naturalWidth,t.tileset.tileHeight/t.image.naturalHeight,1]),_(this.projectionMatrix,this.gl,i,t.location),this.gl.uniformMatrix4fv(this.programManager.projectionMatrixUniform,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(this.programManager.modelMatrixUniform,!1,this.modelMatrix),this.gl.uniformMatrix4fv(this.programManager.textureMatrixUniform,!1,this.textureMatrix),this.gl.enable(this.gl.BLEND);const a=this.textureManager.getOrCreateTextureFromImage(t.image,t.smooth);if(this.lastTexture===a&&e===r.Tilemap||(this.gl.bindTexture(this.gl.TEXTURE_2D,a),this.gl.uniform1i(this.programManager.textureUniform,0),this.lastTexture=a),this.gl.uniform1i(this.programManager.useMaskColorUniform,0),this.gl.uniform1i(this.programManager.renderTextureUniform,1),this.gl.uniform1f(this.programManager.alphaUniform,null!==(o=t.alpha)&&void 0!==o?o:1),this.gl.uniform1i(this.programManager.useTintColorUniform,t.tintColor?1:0),t.tintColor){const{r:i,g:r,b:e,a:s}=b(t.tintColor);this.gl.uniform4f(this.programManager.tintColorUniform,i,r,e,s)}this.gl.drawArrays(this.gl.TRIANGLES,0,this.posVertices.length/2)}generateVertices2(t){this.posVertices=[],this.texVertices=[],t.culledTiles.forEach(((i,r)=>{if(0===i)return;const e=r%t.tilemap.width,s=-r/t.tilemap.width|0;this.posVertices.push(e,s-1,e+1,s-1,e,s,e,s,e+1,s-1,e+1,s);const o=(i-1)%t.tileset.width,a=Math.floor((i-1)/t.tileset.width);this.texVertices.push(o,a+1,o+1,a+1,o,a,o,a,o+1,a+1,o+1,a)}))}generateVertices({culledTiles:t,tilemap:i,tileset:r}){this.posVertices=[],this.texVertices=[];const e=t.length/i.width|0;t.forEach(((t,s)=>{if(0===t)return;const o=s%i.width-i.width/2,a=e/2-(s/i.width|0);this.posVertices.push(o,a-1,o+1,a-1,o,a,o,a,o+1,a-1,o+1,a);const n=(t-1)%r.width,h=Math.floor((t-1)/r.width);this.texVertices.push(n,h+1,n+1,h+1,n,h,n,h,n+1,h+1,n+1,h)}))}}class V{constructor(t){this.gl=t}createFromImage(t,i=!0,r=null){return r=null!=r?r:this.gl.createTexture(),t.naturalWidth?this.create(t,r,i):t.addEventListener("load",(()=>this.create(t,r,i))),r}createFromCanvas(t,i=!0,r=null){return r=null!=r?r:this.gl.createTexture(),this.create(t,r,i),r}create(t,i,r=!0){this.gl.bindTexture(this.gl.TEXTURE_2D,i),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),!1===r?(this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST)):(this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR)),this.gl.bindTexture(this.gl.TEXTURE_2D,null)}}class L{constructor(t){this.textureFactory=t,this.textures=new Map}getOrCreateTextureFromImage(t,i=!0){var r;return null!==(r=this.textures.get(Symbol.for(t.src)))&&void 0!==r?r:this.createTextureFromImage(t,i)}createTextureFromImage(t,i=!0){const r=this.textureFactory.createFromImage(t,i);return this.textures.set(Symbol.for(t.src),r),r}getOrCreateTextureFromCanvas(t,i,r=!0){var e;return null!==(e=this.textures.get(Symbol.for(t)))&&void 0!==e?e:this.createTextureFromCanvas(t,i,r)}createTextureFromCanvas(t,i,r=!0){const e=this.textureFactory.createFromCanvas(i,r);return this.textures.set(Symbol.for(t),e),e}}class I{constructor(t,i,r){this.gl=t,this.renderers=r,i.loadProgram()}render(t,i){this.renderers.get(t.type).render(t,i,this.lastRender),this.lastRender=t.type}clearCanvas(t){const i=b(t);this.gl.clearColor(i.r,i.g,i.b,i.a),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}}var N;!function(t){t[t.Center=0]="Center",t[t.RightUp=1]="RightUp",t[t.RightDown=2]="RightDown",t[t.RightCenter=3]="RightCenter"}(N||(N={}));const k=t=>{const i=new a(t),e=i.gl,h=i.contextVersion,u=new g(e,h,new l(e,new c(e))),m=new L(new V(e)),x=new I(e,u,new Map([[r.Sprite,new U(e,u,m)],[r.Text,new j(e,u,m,new n)],[r.Tilemap,new B(e,u,m)],[r.Geometric,new T(e,u)],[r.Mask,new w(e,u)]]));return new o(x,new s(e))};export{t as GeometricShape,r as RenderDataType,i as RenderLocation,E as TextOrientation,N as TilemapOrientation,k as renderManagerFactory};
